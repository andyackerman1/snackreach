<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - SnackReach</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- DEFINE FUNCTIONS IN HEAD - BEFORE ANY HTML -->
    <script>
        // DEFINE FUNCTIONS IMMEDIATELY - BEFORE PAGE LOADS
        window.showAccounts = function() {
            alert('showAccounts called!'); // Debug
            try {
                document.getElementById('tab-accounts').style.display = 'block';
                document.getElementById('tab-banking').style.display = 'none';
                document.getElementById('tab-settings').style.display = 'none';
                
                document.getElementById('tab-btn-accounts').style.background = '#dc2626';
                document.getElementById('tab-btn-accounts').style.color = 'white';
                document.getElementById('tab-btn-banking').style.background = '#f3f4f6';
                document.getElementById('tab-btn-banking').style.color = '#64748b';
                document.getElementById('tab-btn-settings').style.background = '#f3f4f6';
                document.getElementById('tab-btn-settings').style.color = '#64748b';
                
                if (typeof loadAccounts === 'function') {
                    loadAccounts();
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        };
        
        window.showBanking = function() {
            alert('showBanking called!'); // Debug
            try {
                document.getElementById('tab-accounts').style.display = 'none';
                document.getElementById('tab-banking').style.display = 'block';
                document.getElementById('tab-settings').style.display = 'none';
                
                document.getElementById('tab-btn-accounts').style.background = '#f3f4f6';
                document.getElementById('tab-btn-accounts').style.color = '#64748b';
                document.getElementById('tab-btn-banking').style.background = '#dc2626';
                document.getElementById('tab-btn-banking').style.color = 'white';
                document.getElementById('tab-btn-settings').style.background = '#f3f4f6';
                document.getElementById('tab-btn-settings').style.color = '#64748b';
                
                if (typeof loadBankingInfo === 'function') {
                    loadBankingInfo();
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        };
        
        window.showSettings = function() {
            alert('showSettings called!'); // Debug
            try {
                document.getElementById('tab-accounts').style.display = 'none';
                document.getElementById('tab-banking').style.display = 'none';
                document.getElementById('tab-settings').style.display = 'block';
                
                document.getElementById('tab-btn-accounts').style.background = '#f3f4f6';
                document.getElementById('tab-btn-accounts').style.color = '#64748b';
                document.getElementById('tab-btn-banking').style.background = '#f3f4f6';
                document.getElementById('tab-btn-banking').style.color = '#64748b';
                document.getElementById('tab-btn-settings').style.background = '#dc2626';
                document.getElementById('tab-btn-settings').style.color = 'white';
                
                if (typeof loadOwnerProfile === 'function') {
                    loadOwnerProfile();
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        };
        
        // Also create aliases without "window." for compatibility
        window.showAccounts = window.showAccounts;
        window.showBanking = window.showBanking;
        window.showSettings = window.showSettings;
        
        console.log('Tab functions defined in HEAD:', typeof window.showAccounts, typeof window.showBanking, typeof window.showSettings);
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-utensils"></i>
                <span>SnackReach</span>
            </div>
            <div class="nav-menu">
                <div class="user-info">
                    <span class="user-name" id="owner-name">Owner</span>
                    <span class="subscription-badge">Admin</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <h1>Owner Dashboard</h1>
                <p>Platform administration and payment management</p>
            </div>

            <!-- SIMPLE TABS - Bulletproof -->
            <div style="border-bottom: 2px solid #e5e7eb; margin-bottom: 30px; padding-bottom: 10px; position: relative; z-index: 1;">
                <button id="tab-btn-accounts" onclick="if(window.showAccounts){window.showAccounts();}else{alert('showAccounts not defined');} return false;" style="padding: 15px 30px; margin-right: 10px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer !important; font-size: 16px; font-weight: 600; pointer-events: auto !important; z-index: 9999; position: relative;">All Accounts</button>
                <button id="tab-btn-banking" onclick="if(window.showBanking){window.showBanking();}else{alert('showBanking not defined');} return false;" style="padding: 15px 30px; margin-right: 10px; background: #f3f4f6; color: #64748b; border: none; border-radius: 5px; cursor: pointer !important; font-size: 16px; font-weight: 600; pointer-events: auto !important; z-index: 9999; position: relative;">Banking Info</button>
                <button id="tab-btn-settings" onclick="if(window.showSettings){window.showSettings();}else{alert('showSettings not defined');} return false;" style="padding: 15px 30px; background: #f3f4f6; color: #64748b; border: none; border-radius: 5px; cursor: pointer !important; font-size: 16px; font-weight: 600; pointer-events: auto !important; z-index: 9999; position: relative;">Settings</button>
            </div>

            <!-- Accounts Tab -->
            <div id="tab-accounts" style="display: block;">
                <div class="section-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <h3>All User Accounts</h3>
                            <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                All accounts are stored in the centralized backend database
                            </p>
                        </div>
                        <button class="btn btn-primary" onclick="loadAccounts()" style="margin-left: 1rem;">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                
                <div class="accounts-table-container">
                    <table class="accounts-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Company</th>
                                <th>Created</th>
                                <th>Password</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h4>No accounts yet</h4>
                                        <p>Accounts will appear here once users sign up</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Banking Info Tab -->
            <div id="tab-banking" style="display: none;">
                <div class="profile-section">
                    <h3>Banking Information</h3>
                    <p class="section-description">Submit your banking information to receive payments from users</p>
                    
                    <div class="banking-card" style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);">
                        <div class="banking-info" id="banking-info-display">
                            <h4 style="margin-bottom: 1.5rem;">Current Banking Information</h4>
                            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="detail-label" style="font-weight: 600; color: #374151;">Bank Name:</span>
                                <span class="detail-value" id="bank-name-display" style="color: #64748b;">Not set</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="detail-label" style="font-weight: 600; color: #374151;">Account Holder:</span>
                                <span class="detail-value" id="account-name-display" style="color: #64748b;">Not set</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="detail-label" style="font-weight: 600; color: #374151;">Account Number:</span>
                                <span class="detail-value" id="account-number-display" style="color: #64748b;">Not set</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #e5e7eb;">
                                <span class="detail-label" style="font-weight: 600; color: #374151;">Routing Number:</span>
                                <span class="detail-value" id="routing-number-display" style="color: #64748b;">Not set</span>
                            </div>
                            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 0.75rem 0;">
                                <span class="detail-label" style="font-weight: 600; color: #374151;">Bank Address:</span>
                                <span class="detail-value" id="bank-address-display" style="color: #64748b;">Not set</span>
                            </div>
                            <button class="btn btn-primary" onclick="editBankingInfo()" style="margin-top: 1.5rem; width: 100%;">
                                <i class="fas fa-plus"></i>
                                Add / Update Banking Info
                            </button>
                        </div>

                        <div class="banking-form" id="banking-form" style="display: none;">
                            <h4 style="margin-bottom: 1.5rem;">Submit Banking Information</h4>
                            <p style="margin-bottom: 1.5rem; color: #64748b;">Choose how you want to add your banking information</p>
                            
                            <div class="payment-type-tabs" style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">
                                <button class="payment-tab-btn active" onclick="switchPaymentType('card')">
                                    <i class="fas fa-credit-card"></i>
                                    Credit/Debit Card
                                </button>
                                <button class="payment-tab-btn" onclick="switchPaymentType('bank')">
                                    <i class="fas fa-university"></i>
                                    Bank Account
                                </button>
                            </div>
                            
                            <!-- Credit Card Form -->
                            <form id="card-payment-form-owner" class="payment-form">
                                <div class="form-group">
                                    <label for="card-type-owner">Card Type</label>
                                    <select id="card-type-owner" required>
                                        <option value="">Select card type...</option>
                                        <option value="visa">Visa</option>
                                        <option value="mastercard">Mastercard</option>
                                        <option value="amex">American Express</option>
                                        <option value="discover">Discover</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="card-number-owner">Card Number</label>
                                    <input type="text" id="card-number-owner" placeholder="1234 5678 9012 3456" maxlength="19" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="card-expiry-owner">Expiry Date</label>
                                        <input type="text" id="card-expiry-owner" placeholder="MM/YY" maxlength="5" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="card-cvv-owner">CVV</label>
                                        <input type="text" id="card-cvv-owner" placeholder="123" maxlength="4" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="card-name-owner">Name on Card</label>
                                    <input type="text" id="card-name-owner" placeholder="John Doe" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="card-billing-address-owner">Billing Address</label>
                                    <input type="text" id="card-billing-address-owner" placeholder="123 Main St, City, State 12345" required>
                                </div>
                                
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="set-default-card-owner">
                                    <label for="set-default-card-owner">Set as default payment method</label>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-outline" onclick="cancelEditBanking()">Cancel</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-lock"></i>
                                        Add Card
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Bank Account Form - Using Plaid Link -->
                            <div id="bank-payment-form-owner" class="payment-form" style="display: none;">
                                <div class="plaid-link-container">
                                    <div class="security-info">
                                        <i class="fas fa-shield-alt"></i>
                                        <h4>Secure Bank Verification</h4>
                                        <p>We use Plaid to securely connect your bank account. Your bank credentials are never stored on our servers.</p>
                                    </div>
                                    
                                    <div class="plaid-features">
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>256-bit SSL encryption</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Bank-level security</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>No account numbers stored</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Read-only access</span>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group checkbox-group">
                                        <input type="checkbox" id="set-default-bank-plaid-owner">
                                        <label for="set-default-bank-plaid-owner">Set as default payment method</label>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-outline" onclick="cancelEditBanking()">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="plaid-link-button-owner" onclick="initiatePlaidBankLinkOwner()">
                                            <i class="fas fa-university"></i>
                                            Connect Bank Account
                                        </button>
                                    </div>
                                    
                                    <div id="plaid-link-status-owner" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px;">
                                        <p id="plaid-status-message-owner"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" style="display: none;">
                <div class="profile-section">
                    <h3>Owner Profile & Settings</h3>
                    
                    <div class="profile-card" style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1.5rem; font-size: 1.25rem; color: #1e293b;">Personal Information</h4>
                        <div class="profile-form">
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Username</label>
                                    <input type="text" id="owner-username-input" placeholder="Your username" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Full Name</label>
                                    <input type="text" id="owner-name-input" placeholder="Your full name" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Email</label>
                                    <input type="email" id="owner-email-input" placeholder="your@email.com" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Phone Number</label>
                                    <input type="tel" id="owner-phone-input" placeholder="(555) 123-4567" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Company Name</label>
                                <input type="text" id="owner-company-input" placeholder="Company name" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <button class="btn btn-primary" onclick="saveOwnerProfile()" style="width: 100%;">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>

                    <div class="profile-card" style="background: white; padding: 2rem; border-radius: 16px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); margin-bottom: 2rem;">
                        <h4 style="margin-bottom: 1.5rem; font-size: 1.25rem; color: #1e293b;">Change Password</h4>
                        <div class="profile-form">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Current Password</label>
                                <input type="password" id="owner-current-password" placeholder="Enter current password" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                            </div>
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">New Password</label>
                                    <input type="password" id="owner-new-password" placeholder="Enter new password" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">Confirm New Password</label>
                                    <input type="password" id="owner-confirm-password" placeholder="Confirm new password" style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem;">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="changePassword()" style="width: 100%;">
                                <i class="fas fa-key"></i>
                                Change Password
                            </button>
                        </div>
                    </div>

                    <div class="profile-card" style="margin-top: 2rem;">
                        <h4>Account Actions</h4>
                        <div class="account-actions">
                            <div class="action-item">
                                <div class="action-info">
                                    <h5>Export Data</h5>
                                    <p>Download all platform data as CSV</p>
                                </div>
                                <button class="btn btn-outline btn-small" onclick="exportData()">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                            <div class="logout-section">
                                <button class="btn btn-outline" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="js/plaid-link.js"></script>
    <script>
        // Verify functions are available
        console.log('Functions available:', {
            showAccounts: typeof window.showAccounts,
            showBanking: typeof window.showBanking,
            showSettings: typeof window.showSettings
        });
        
        // Dynamic API URL detection - only declare once using var (function-scoped, not block-scoped)
        if (typeof window.API_BASE_URL === 'undefined') {
            window.API_BASE_URL = (() => {
                const hostname = window.location.hostname;
                const protocol = window.location.protocol;
                
                if (protocol === 'file:' || hostname === '') {
                    return 'https://snackreach-production.up.railway.app/api';
                }
                
                if (hostname.includes('railway.app')) {
                    return '/api';
                } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    return 'https://snackreach-production.up.railway.app/api';
                } else {
                    return 'http://localhost:3000/api';
                }
            })();
        }
        
        // Reference API_BASE_URL from window, don't redeclare
        console.log('API Base URL:', window.API_BASE_URL);

        // Check authentication
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('snackreach_token');
            const userType = localStorage.getItem('snackreach_user_type');
            const ownerName = localStorage.getItem('snackreach_user_name');
            
            if (!token || userType !== 'owner') {
                alert('Access denied. Owner account required.');
                window.location.href = 'owner-login.html';
                return;
            }

            if (ownerName) {
                document.getElementById('owner-name').textContent = ownerName;
            }
            
            loadAccounts();
            loadBankingInfo();
            loadOwnerProfile();
        });

        // Load accounts
        async function loadAccounts() {
            try {
                const token = localStorage.getItem('snackreach_token');
                if (!token) {
                    displayAccounts([]);
                    return;
                }
                
                const response = await fetch(`${window.API_BASE_URL}/admin/all-accounts`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const accounts = await response.json();
                    displayAccounts(accounts);
                } else {
                    displayAccounts([]);
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
                displayAccounts([]);
            }
        }
        
        function displayAccounts(accounts) {
            const tbody = document.getElementById('accounts-table-body');
            
            if (accounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h4>No accounts yet</h4>
                                <p>Accounts will appear here once users sign up</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = accounts.map(account => `
                <tr>
                    <td>${account.name || account.companyName || 'N/A'}</td>
                    <td>${account.email || 'N/A'}</td>
                    <td>${account.userType || 'N/A'}</td>
                    <td>${account.companyName || 'N/A'}</td>
                    <td>${account.createdAt ? new Date(account.createdAt).toLocaleDateString() : 'N/A'}</td>
                    <td>${account.password ? account.password : 'Hashed (cannot view)'}</td>
                </tr>
            `).join('');
        }
        
        window.loadAccounts = loadAccounts;

        // Banking functions
        async function loadBankingInfo() {
            const bankName = localStorage.getItem('owner_bank_name');
            const accountName = localStorage.getItem('owner_account_name');
            const accountNumber = localStorage.getItem('owner_account_number');
            const routingNumber = localStorage.getItem('owner_routing_number');
            const bankAddress = localStorage.getItem('owner_bank_address');
            
            if (bankName || accountName) {
                document.getElementById('bank-name-display').textContent = bankName || '-';
                document.getElementById('account-name-display').textContent = accountName || '-';
                document.getElementById('account-number-display').textContent = accountNumber ? '****' + accountNumber.slice(-4) : '-';
                document.getElementById('routing-number-display').textContent = routingNumber || '-';
                document.getElementById('bank-address-display').textContent = bankAddress || '-';
            }
        }
        
        function editBankingInfo() {
            document.getElementById('banking-info-display').style.display = 'none';
            document.getElementById('banking-form').style.display = 'block';
        }
        
        function cancelEditBanking() {
            document.getElementById('banking-info-display').style.display = 'block';
            document.getElementById('banking-form').style.display = 'none';
            // Reset form
            document.getElementById('card-payment-form-owner').reset();
            document.getElementById('card-payment-form-owner').style.display = 'block';
            document.getElementById('bank-payment-form-owner').style.display = 'none';
        }
        
        function switchPaymentType(type) {
            const cardForm = document.getElementById('card-payment-form-owner');
            const bankForm = document.getElementById('bank-payment-form-owner');
            const tabs = document.querySelectorAll('.payment-tab-btn');
            
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
                tab.style.borderBottomColor = 'transparent';
                tab.style.color = '#64748b';
            });
            
            if (type === 'card') {
                cardForm.style.display = 'block';
                bankForm.style.display = 'none';
                if (tabs[0]) {
                    tabs[0].classList.add('active');
                    tabs[0].style.borderBottomColor = '#dc2626';
                    tabs[0].style.color = '#dc2626';
                }
            } else {
                cardForm.style.display = 'none';
                bankForm.style.display = 'block';
                if (tabs[1]) {
                    tabs[1].classList.add('active');
                    tabs[1].style.borderBottomColor = '#dc2626';
                    tabs[1].style.color = '#dc2626';
                }
            }
        }
        
        // Handle card form submission
        document.addEventListener('DOMContentLoaded', function() {
            const cardForm = document.getElementById('card-payment-form-owner');
            if (cardForm) {
                cardForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveBankingInfo();
                });
            }
        });
        
        function saveBankingInfo() {
            const cardType = document.getElementById('card-type-owner').value;
            const cardNumber = document.getElementById('card-number-owner').value;
            const cardExpiry = document.getElementById('card-expiry-owner').value;
            const cardCVV = document.getElementById('card-cvv-owner').value;
            const cardName = document.getElementById('card-name-owner').value;
            const cardAddress = document.getElementById('card-billing-address-owner').value;
            
            if (!cardType || !cardNumber || !cardExpiry || !cardCVV || !cardName || !cardAddress) {
                alert('Please fill in all card fields');
                return;
            }
            
            // Save to localStorage (in production, this would go to backend)
            localStorage.setItem('owner_bank_name', cardType + ' Card');
            localStorage.setItem('owner_account_name', cardName);
            localStorage.setItem('owner_account_number', cardNumber);
            localStorage.setItem('owner_routing_number', 'N/A');
            localStorage.setItem('owner_bank_address', cardAddress);
            
            alert('Banking information saved successfully!');
            cancelEditBanking();
            loadBankingInfo();
        }
        
        window.editBankingInfo = editBankingInfo;
        window.cancelEditBanking = cancelEditBanking;
        window.switchPaymentType = switchPaymentType;
        window.loadBankingInfo = loadBankingInfo;
        window.saveBankingInfo = saveBankingInfo;
        window.changePassword = changePassword;

        // Plaid integration
        if (typeof initiatePlaidBankLinkOwner === 'undefined') {
            window.initiatePlaidBankLinkOwner = function() {
                alert('Plaid integration not available. Please use the production site for full functionality.');
            };
        } else {
            window.initiatePlaidBankLinkOwner = initiatePlaidBankLinkOwner;
        }

        // Owner profile
        async function loadOwnerProfile() {
            const name = localStorage.getItem('snackreach_user_name');
            const email = localStorage.getItem('snackreach_user_email');
            const company = localStorage.getItem('snackreach_company_name');
            const username = localStorage.getItem('snackreach_user_username');
            const phone = localStorage.getItem('snackreach_user_phone');
            
            if (name) document.getElementById('owner-name-input').value = name;
            if (email) document.getElementById('owner-email-input').value = email;
            if (company) document.getElementById('owner-company-input').value = company;
            if (username) document.getElementById('owner-username-input').value = username;
            if (phone) document.getElementById('owner-phone-input').value = phone;
        }
        
        async function saveOwnerProfile() {
            const name = document.getElementById('owner-name-input').value;
            const email = document.getElementById('owner-email-input').value;
            const company = document.getElementById('owner-company-input').value;
            const username = document.getElementById('owner-username-input').value;
            const phone = document.getElementById('owner-phone-input').value;
            
            if (!email || !name) {
                alert('Please fill in at least name and email');
                return;
            }
            
            // Save to localStorage
            localStorage.setItem('snackreach_user_name', name);
            localStorage.setItem('snackreach_user_email', email);
            localStorage.setItem('snackreach_company_name', company);
            localStorage.setItem('snackreach_user_username', username);
            localStorage.setItem('snackreach_user_phone', phone);
            
            // Try to save to backend
            try {
                const token = localStorage.getItem('snackreach_token');
                if (token) {
                    const response = await fetch(`${window.API_BASE_URL}/admin/update-profile`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            email: email,
                            companyName: company,
                            username: username,
                            phone: phone
                        })
                    });
                    
                    if (response.ok) {
                        alert('Profile saved successfully!');
                    } else {
                        alert('Profile saved locally. Backend update may have failed.');
                    }
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Profile saved locally. Could not connect to backend.');
            }
            
            document.getElementById('owner-name').textContent = name || 'Owner';
        }
        
        async function changePassword() {
            const currentPassword = document.getElementById('owner-current-password').value;
            const newPassword = document.getElementById('owner-new-password').value;
            const confirmPassword = document.getElementById('owner-confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Please fill in all password fields');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long');
                return;
            }
            
            try {
                const token = localStorage.getItem('snackreach_token');
                if (!token) {
                    alert('Not authenticated. Please log in again.');
                    return;
                }
                
                const response = await fetch(`${window.API_BASE_URL}/admin/change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                });
                
                if (response.ok) {
                    alert('Password changed successfully!');
                    document.getElementById('owner-current-password').value = '';
                    document.getElementById('owner-new-password').value = '';
                    document.getElementById('owner-confirm-password').value = '';
                } else {
                    const data = await response.json();
                    alert('Failed to change password: ' + (data.error || 'Invalid current password'));
                }
            } catch (error) {
                console.error('Error changing password:', error);
                alert('Failed to change password. Please try again.');
            }
        }
        
        window.loadOwnerProfile = loadOwnerProfile;
        window.saveOwnerProfile = saveOwnerProfile;

        // Export and logout
        function exportData() {
            alert('Export functionality coming soon!');
        }
        
        function logout() {
            localStorage.removeItem('snackreach_token');
            localStorage.removeItem('snackreach_user_type');
            localStorage.removeItem('snackreach_user_name');
            window.location.href = 'owner-login.html';
        }
        
        window.exportData = exportData;
        window.logout = logout;
    </script>
</body>
</html>
