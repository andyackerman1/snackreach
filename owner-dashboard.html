<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - SnackReach</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-utensils"></i>
                <span>SnackReach</span>
            </div>
            <div class="nav-menu">
                <div class="user-info">
                    <span class="user-name" id="owner-name">Owner</span>
                    <span class="subscription-badge">Admin</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <h1>Owner Dashboard</h1>
                <p>Platform administration and payment management</p>
            </div>

            <!-- SIMPLE TABS - Bulletproof -->
            <div style="border-bottom: 2px solid #e5e7eb; margin-bottom: 30px; padding-bottom: 10px;">
                <button id="tab-btn-accounts" onclick="showAccounts()" style="padding: 15px 30px; margin-right: 10px; background: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">All Accounts</button>
                <button id="tab-btn-banking" onclick="showBanking()" style="padding: 15px 30px; margin-right: 10px; background: #f3f4f6; color: #64748b; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">Banking Info</button>
                <button id="tab-btn-settings" onclick="showSettings()" style="padding: 15px 30px; background: #f3f4f6; color: #64748b; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;">Settings</button>
            </div>

            <!-- Accounts Tab -->
            <div id="tab-accounts" style="display: block;">
                <div class="section-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div>
                            <h3>All User Accounts</h3>
                            <p style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                All accounts are stored in the centralized backend database
                            </p>
                        </div>
                        <button class="btn btn-primary" onclick="loadAccounts()" style="margin-left: 1rem;">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                </div>
                
                <div class="accounts-table-container">
                    <table class="accounts-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Company</th>
                                <th>Created</th>
                                <th>Password</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table-body">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 2rem;">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h4>No accounts yet</h4>
                                        <p>Accounts will appear here once users sign up</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Banking Info Tab -->
            <div id="tab-banking" style="display: none;">
                <div class="profile-section">
                    <h3>Banking Information</h3>
                    <p class="section-description">This is where payments from users will be deposited</p>
                    
                    <div class="banking-card">
                        <div class="banking-info" id="banking-info-display">
                            <h4>Current Banking Information</h4>
                            <div class="detail-row">
                                <span class="detail-label">Bank Name:</span>
                                <span class="detail-value" id="bank-name-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Account Holder:</span>
                                <span class="detail-value" id="account-name-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Account Number:</span>
                                <span class="detail-value" id="account-number-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Routing Number:</span>
                                <span class="detail-value" id="routing-number-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Bank Address:</span>
                                <span class="detail-value" id="bank-address-display">-</span>
                            </div>
                            <button class="btn btn-outline btn-small" onclick="editBankingInfo()" style="margin-top: 1rem;">
                                <i class="fas fa-edit"></i>
                                Edit Banking Info
                            </button>
                        </div>

                        <div class="banking-form" id="banking-form" style="display: none;">
                            <h4>Add Payment Method</h4>
                            <div class="payment-type-tabs">
                                <button class="payment-tab-btn active" onclick="switchPaymentType('card')">
                                    <i class="fas fa-credit-card"></i>
                                    Credit/Debit Card
                                </button>
                                <button class="payment-tab-btn" onclick="switchPaymentType('bank')">
                                    <i class="fas fa-university"></i>
                                    Bank Account
                                </button>
                            </div>
                            
                            <!-- Credit Card Form -->
                            <form id="card-payment-form-owner" class="payment-form">
                                <div class="form-group">
                                    <label for="card-type-owner">Card Type</label>
                                    <select id="card-type-owner" required>
                                        <option value="">Select card type...</option>
                                        <option value="visa">Visa</option>
                                        <option value="mastercard">Mastercard</option>
                                        <option value="amex">American Express</option>
                                        <option value="discover">Discover</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="card-number-owner">Card Number</label>
                                    <input type="text" id="card-number-owner" placeholder="1234 5678 9012 3456" maxlength="19" required>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="card-expiry-owner">Expiry Date</label>
                                        <input type="text" id="card-expiry-owner" placeholder="MM/YY" maxlength="5" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="card-cvv-owner">CVV</label>
                                        <input type="text" id="card-cvv-owner" placeholder="123" maxlength="4" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="card-name-owner">Name on Card</label>
                                    <input type="text" id="card-name-owner" placeholder="John Doe" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="card-billing-address-owner">Billing Address</label>
                                    <input type="text" id="card-billing-address-owner" placeholder="123 Main St, City, State 12345" required>
                                </div>
                                
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="set-default-card-owner">
                                    <label for="set-default-card-owner">Set as default payment method</label>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-outline" onclick="cancelEditBanking()">Cancel</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-lock"></i>
                                        Add Card
                                    </button>
                                </div>
                            </form>
                            
                            <!-- Bank Account Form - Using Plaid Link -->
                            <div id="bank-payment-form-owner" class="payment-form" style="display: none;">
                                <div class="plaid-link-container">
                                    <div class="security-info">
                                        <i class="fas fa-shield-alt"></i>
                                        <h4>Secure Bank Verification</h4>
                                        <p>We use Plaid to securely connect your bank account. Your bank credentials are never stored on our servers.</p>
                                    </div>
                                    
                                    <div class="plaid-features">
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>256-bit SSL encryption</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Bank-level security</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>No account numbers stored</span>
                                        </div>
                                        <div class="feature-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span>Read-only access</span>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group checkbox-group">
                                        <input type="checkbox" id="set-default-bank-plaid-owner">
                                        <label for="set-default-bank-plaid-owner">Set as default payment method</label>
                                    </div>
                                    
                                    <div class="form-actions">
                                        <button type="button" class="btn btn-outline" onclick="cancelEditBanking()">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="plaid-link-button-owner" onclick="initiatePlaidBankLinkOwner()">
                                            <i class="fas fa-university"></i>
                                            Connect Bank Account
                                        </button>
                                    </div>
                                    
                                    <div id="plaid-link-status-owner" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px;">
                                        <p id="plaid-status-message-owner"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" style="display: none;">
                <div class="profile-section">
                    <h3>Owner Profile & Settings</h3>
                    
                    <div class="profile-card">
                        <h4>Personal Information</h4>
                        <div class="profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" id="owner-name-input" placeholder="Your name">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="owner-email-input" placeholder="your@email.com">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Company Name</label>
                                <input type="text" id="owner-company-input" placeholder="Company name">
                            </div>
                            <button class="btn btn-primary" onclick="saveOwnerProfile()">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </div>
                    </div>

                    <div class="profile-card" style="margin-top: 2rem;">
                        <h4>Account Actions</h4>
                        <div class="account-actions">
                            <div class="action-item">
                                <div class="action-info">
                                    <h5>Export Data</h5>
                                    <p>Download all platform data as CSV</p>
                                </div>
                                <button class="btn btn-outline btn-small" onclick="exportData()">
                                    <i class="fas fa-download"></i>
                                    Export
                                </button>
                            </div>
                            <div class="logout-section">
                                <button class="btn btn-outline" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="js/plaid-link.js"></script>
    <script>
        // Dynamic API URL detection
        const API_BASE_URL = (() => {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            if (protocol === 'file:' || hostname === '') {
                return 'https://snackreach-production.up.railway.app/api';
            }
            
            if (hostname.includes('railway.app')) {
                return '/api';
            } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                return 'https://snackreach-production.up.railway.app/api';
            } else {
                return 'http://localhost:3000/api';
            }
        })();
        
        console.log('API Base URL:', API_BASE_URL);

        // SIMPLEST POSSIBLE TAB FUNCTIONS - using direct onclick
        function showAccounts() {
            document.getElementById('tab-accounts').style.display = 'block';
            document.getElementById('tab-banking').style.display = 'none';
            document.getElementById('tab-settings').style.display = 'none';
            
            document.getElementById('tab-btn-accounts').style.background = '#dc2626';
            document.getElementById('tab-btn-accounts').style.color = 'white';
            document.getElementById('tab-btn-banking').style.background = '#f3f4f6';
            document.getElementById('tab-btn-banking').style.color = '#64748b';
            document.getElementById('tab-btn-settings').style.background = '#f3f4f6';
            document.getElementById('tab-btn-settings').style.color = '#64748b';
            
            if (typeof loadAccounts === 'function') {
                loadAccounts();
            }
        }
        
        function showBanking() {
            document.getElementById('tab-accounts').style.display = 'none';
            document.getElementById('tab-banking').style.display = 'block';
            document.getElementById('tab-settings').style.display = 'none';
            
            document.getElementById('tab-btn-accounts').style.background = '#f3f4f6';
            document.getElementById('tab-btn-accounts').style.color = '#64748b';
            document.getElementById('tab-btn-banking').style.background = '#dc2626';
            document.getElementById('tab-btn-banking').style.color = 'white';
            document.getElementById('tab-btn-settings').style.background = '#f3f4f6';
            document.getElementById('tab-btn-settings').style.color = '#64748b';
            
            if (typeof loadBankingInfo === 'function') {
                loadBankingInfo();
            }
        }
        
        function showSettings() {
            document.getElementById('tab-accounts').style.display = 'none';
            document.getElementById('tab-banking').style.display = 'none';
            document.getElementById('tab-settings').style.display = 'block';
            
            document.getElementById('tab-btn-accounts').style.background = '#f3f4f6';
            document.getElementById('tab-btn-accounts').style.color = '#64748b';
            document.getElementById('tab-btn-banking').style.background = '#f3f4f6';
            document.getElementById('tab-btn-banking').style.color = '#64748b';
            document.getElementById('tab-btn-settings').style.background = '#dc2626';
            document.getElementById('tab-btn-settings').style.color = 'white';
            
            if (typeof loadOwnerProfile === 'function') {
                loadOwnerProfile();
            }
        }
        
        // Make functions global
        window.showAccounts = showAccounts;
        window.showBanking = showBanking;
        window.showSettings = showSettings;

        // Check authentication
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('snackreach_token');
            const userType = localStorage.getItem('snackreach_user_type');
            const ownerName = localStorage.getItem('snackreach_user_name');
            
            if (!token || userType !== 'owner') {
                alert('Access denied. Owner account required.');
                window.location.href = 'owner-login.html';
                return;
            }

            if (ownerName) {
                document.getElementById('owner-name').textContent = ownerName;
            }
            
            loadAccounts();
            loadBankingInfo();
            loadOwnerProfile();
        });

        // Load accounts
        async function loadAccounts() {
            try {
                const token = localStorage.getItem('snackreach_token');
                if (!token) {
                    displayAccounts([]);
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/admin/all-accounts`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const accounts = await response.json();
                    displayAccounts(accounts);
                } else {
                    displayAccounts([]);
                }
            } catch (error) {
                console.error('Error loading accounts:', error);
                displayAccounts([]);
            }
        }
        
        function displayAccounts(accounts) {
            const tbody = document.getElementById('accounts-table-body');
            
            if (accounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h4>No accounts yet</h4>
                                <p>Accounts will appear here once users sign up</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = accounts.map(account => `
                <tr>
                    <td>${account.name || account.companyName || 'N/A'}</td>
                    <td>${account.email || 'N/A'}</td>
                    <td>${account.userType || 'N/A'}</td>
                    <td>${account.companyName || 'N/A'}</td>
                    <td>${account.createdAt ? new Date(account.createdAt).toLocaleDateString() : 'N/A'}</td>
                    <td>${account.password ? account.password : 'Hashed (cannot view)'}</td>
                </tr>
            `).join('');
        }
        
        window.loadAccounts = loadAccounts;

        // Banking functions
        async function loadBankingInfo() {
            const bankName = localStorage.getItem('owner_bank_name');
            const accountName = localStorage.getItem('owner_account_name');
            const accountNumber = localStorage.getItem('owner_account_number');
            const routingNumber = localStorage.getItem('owner_routing_number');
            const bankAddress = localStorage.getItem('owner_bank_address');
            
            if (bankName || accountName) {
                document.getElementById('bank-name-display').textContent = bankName || '-';
                document.getElementById('account-name-display').textContent = accountName || '-';
                document.getElementById('account-number-display').textContent = accountNumber ? '****' + accountNumber.slice(-4) : '-';
                document.getElementById('routing-number-display').textContent = routingNumber || '-';
                document.getElementById('bank-address-display').textContent = bankAddress || '-';
            }
        }
        
        function editBankingInfo() {
            document.getElementById('banking-info-display').style.display = 'none';
            document.getElementById('banking-form').style.display = 'block';
        }
        
        function cancelEditBanking() {
            document.getElementById('banking-info-display').style.display = 'block';
            document.getElementById('banking-form').style.display = 'none';
        }
        
        function switchPaymentType(type) {
            const cardForm = document.getElementById('card-payment-form-owner');
            const bankForm = document.getElementById('bank-payment-form-owner');
            const tabs = document.querySelectorAll('.payment-tab-btn');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            
            if (type === 'card') {
                cardForm.style.display = 'block';
                bankForm.style.display = 'none';
                tabs[0].classList.add('active');
            } else {
                cardForm.style.display = 'none';
                bankForm.style.display = 'block';
                tabs[1].classList.add('active');
            }
        }
        
        window.editBankingInfo = editBankingInfo;
        window.cancelEditBanking = cancelEditBanking;
        window.switchPaymentType = switchPaymentType;
        window.loadBankingInfo = loadBankingInfo;

        // Plaid integration
        if (typeof initiatePlaidBankLinkOwner === 'undefined') {
            window.initiatePlaidBankLinkOwner = function() {
                alert('Plaid integration not available. Please use the production site for full functionality.');
            };
        } else {
            window.initiatePlaidBankLinkOwner = initiatePlaidBankLinkOwner;
        }

        // Owner profile
        async function loadOwnerProfile() {
            const name = localStorage.getItem('snackreach_user_name');
            const email = localStorage.getItem('snackreach_user_email');
            const company = localStorage.getItem('snackreach_company_name');
            
            if (name) document.getElementById('owner-name-input').value = name;
            if (email) document.getElementById('owner-email-input').value = email;
            if (company) document.getElementById('owner-company-input').value = company;
        }
        
        function saveOwnerProfile() {
            const name = document.getElementById('owner-name-input').value;
            const email = document.getElementById('owner-email-input').value;
            const company = document.getElementById('owner-company-input').value;
            
            localStorage.setItem('snackreach_user_name', name);
            localStorage.setItem('snackreach_user_email', email);
            localStorage.setItem('snackreach_company_name', company);
            
            document.getElementById('owner-name').textContent = name || 'Owner';
            
            alert('Profile saved!');
        }
        
        window.loadOwnerProfile = loadOwnerProfile;
        window.saveOwnerProfile = saveOwnerProfile;

        // Export and logout
        function exportData() {
            alert('Export functionality coming soon!');
        }
        
        function logout() {
            localStorage.removeItem('snackreach_token');
            localStorage.removeItem('snackreach_user_type');
            localStorage.removeItem('snackreach_user_name');
            window.location.href = 'owner-login.html';
        }
        
        window.exportData = exportData;
        window.logout = logout;
    </script>
</body>
</html>
