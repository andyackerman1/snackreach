<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - SnackReach</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-utensils"></i>
                <span>SnackReach</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Back to Home</a>
                <div class="user-info">
                    <span class="user-name" id="owner-name">Owner</span>
                    <span class="subscription-badge">Admin</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <h1>Owner Dashboard</h1>
                <p>Platform administration and payment management</p>
            </div>

            <!-- Dashboard Tabs -->
            <div class="dashboard-tabs">
                <button class="tab-btn active" onclick="showTab('overview')">
                    <i class="fas fa-chart-line"></i>
                    Overview
                </button>
                <button class="tab-btn" onclick="showTab('accounts')">
                    <i class="fas fa-users"></i>
                    All Accounts
                </button>
                <button class="tab-btn" onclick="showTab('banking')">
                    <i class="fas fa-university"></i>
                    Banking Info
                </button>
                <button class="tab-btn" onclick="showTab('payments')">
                    <i class="fas fa-dollar-sign"></i>
                    Payments
                </button>
                <button class="tab-btn" onclick="showTab('messages')">
                    <i class="fas fa-envelope"></i>
                    Messages
                </button>
                <button class="tab-btn" onclick="showTab('settings')">
                    <i class="fas fa-cog"></i>
                    Settings
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-users">0</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-rocket"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-startups">0</h3>
                            <p>Snack Companies</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-offices">0</h3>
                            <p>Office Spaces</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-revenue">$0</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="recent-activity-list">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <h4>No recent activity</h4>
                            <p>User activity will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Accounts Tab -->
            <div id="accounts-tab" class="tab-content">
                <div class="section-header">
                    <h3>All User Accounts</h3>
                    <div class="account-filters">
                        <select id="account-type-filter">
                            <option value="">All Types</option>
                            <option value="startup">Snack Companies</option>
                            <option value="office">Offices</option>
                            <option value="owner">Owners</option>
                        </select>
                        <input type="text" id="account-search" placeholder="Search accounts...">
                    </div>
                </div>
                
                <div class="accounts-table-container">
                    <table class="accounts-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Company</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table-body">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 2rem;">
                                    <div class="empty-state">
                                        <div class="empty-icon">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <h4>No accounts yet</h4>
                                        <p>User accounts will appear here once they sign up</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Banking Info Tab -->
            <div id="banking-tab" class="tab-content">
                <div class="profile-section">
                    <h3>Banking Information</h3>
                    <p class="section-description">This is where payments from users will be deposited</p>
                    
                    <div class="banking-card">
                        <div class="banking-header">
                            <h4>Payment Account Details</h4>
                            <button class="btn btn-outline btn-small" onclick="editBankingInfo()">
                                <i class="fas fa-edit"></i>
                                Edit
                            </button>
                        </div>
                        
                        <div class="banking-details" id="banking-details">
                            <div class="detail-row">
                                <span class="detail-label">Bank Name:</span>
                                <span class="detail-value" id="bank-name-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Account Holder:</span>
                                <span class="detail-value" id="account-name-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Account Number:</span>
                                <span class="detail-value" id="account-number-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Routing Number:</span>
                                <span class="detail-value" id="routing-number-display">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Bank Address:</span>
                                <span class="detail-value" id="bank-address-display">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="banking-form" id="banking-form" style="display: none;">
                        <h4>Add Payment Method</h4>
                        <div class="payment-type-tabs">
                            <button class="payment-tab-btn active" onclick="switchPaymentType('card')">
                                <i class="fas fa-credit-card"></i>
                                Credit/Debit Card
                            </button>
                            <button class="payment-tab-btn" onclick="switchPaymentType('bank')">
                                <i class="fas fa-university"></i>
                                Bank Account
                            </button>
                        </div>
                        
                        <!-- Credit Card Form -->
                        <form id="card-payment-form-owner" class="payment-form">
                            <div class="form-group">
                                <label for="card-type-owner">Card Type</label>
                                <select id="card-type-owner" required>
                                    <option value="">Select card type...</option>
                                    <option value="visa">Visa</option>
                                    <option value="mastercard">Mastercard</option>
                                    <option value="amex">American Express</option>
                                    <option value="discover">Discover</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="card-number-owner">Card Number</label>
                                <input type="text" id="card-number-owner" placeholder="1234 5678 9012 3456" maxlength="19" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="card-expiry-owner">Expiry Date</label>
                                    <input type="text" id="card-expiry-owner" placeholder="MM/YY" maxlength="5" required>
                                </div>
                                <div class="form-group">
                                    <label for="card-cvv-owner">CVV</label>
                                    <input type="text" id="card-cvv-owner" placeholder="123" maxlength="4" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="card-name-owner">Name on Card</label>
                                <input type="text" id="card-name-owner" placeholder="John Doe" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="card-billing-address-owner">Billing Address</label>
                                <input type="text" id="card-billing-address-owner" placeholder="123 Main St, City, State 12345" required>
                            </div>
                            
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="set-default-card-owner">
                                <label for="set-default-card-owner">Set as default payment method</label>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" onclick="cancelEditBanking()">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-lock"></i>
                                    Add Card
                                </button>
                            </div>
                        </form>
                        
                        <!-- Bank Account Form -->
                        <form id="bank-payment-form-owner" class="payment-form" style="display: none;">
                            <div class="form-group">
                                <label for="bank-name-owner">Bank Name</label>
                                <select id="bank-name-owner" required>
                                    <option value="">Select bank...</option>
                                    <option value="chase">Chase</option>
                                    <option value="bank-of-america">Bank of America</option>
                                    <option value="wells-fargo">Wells Fargo</option>
                                    <option value="citibank">Citibank</option>
                                    <option value="us-bank">U.S. Bank</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="other-bank-input-owner" style="display: none;">
                                <label for="other-bank-name-owner">Enter Bank Name</label>
                                <input type="text" id="other-bank-name-owner" placeholder="Bank name">
                            </div>
                            
                            <div class="form-group">
                                <label for="account-type-owner">Account Type</label>
                                <select id="account-type-owner" required>
                                    <option value="">Select account type...</option>
                                    <option value="checking">Checking</option>
                                    <option value="savings">Savings</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="account-number-owner">Account Number</label>
                                <input type="text" id="account-number-owner" placeholder="Enter account number" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="routing-number-owner">Routing Number</label>
                                <input type="text" id="routing-number-owner" placeholder="Enter 9-digit routing number" maxlength="9" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="account-holder-name-owner">Account Holder Name</label>
                                <input type="text" id="account-holder-name-owner" placeholder="Name as it appears on account" required>
                            </div>
                            
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="set-default-bank-owner">
                                <label for="set-default-bank-owner">Set as default payment method</label>
                            </div>
                            
                            <div class="security-note">
                                <i class="fas fa-shield-alt"></i>
                                <p>Your bank account information is encrypted and secure. We use industry-standard security measures to protect your financial data.</p>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-outline" onclick="cancelEditBanking()">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-lock"></i>
                                    Link Bank Account
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Payments Tab -->
            <div id="payments-tab" class="tab-content">
                <div class="section-header">
                    <h3>Payment History</h3>
                    <div class="payment-filters">
                        <select>
                            <option>All Payments</option>
                            <option>This Month</option>
                            <option>Last 3 Months</option>
                            <option>This Year</option>
                        </select>
                    </div>
                </div>
                
                <div class="payments-list" id="payments-list">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h4>No payments yet</h4>
                        <p>Payment history will appear here as users subscribe</p>
                    </div>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages-tab" class="tab-content">
                <div class="messages-container">
                    <div class="messages-sidebar">
                        <div class="messages-header">
                            <h3>All Users</h3>
                            <button class="btn btn-primary btn-small" onclick="startNewMessage()">
                                <i class="fas fa-plus"></i>
                                New Message
                            </button>
                        </div>
                        
                        <div class="user-list" id="owner-user-list">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="messages-main">
                        <div id="no-conversation-selected" class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <h4>Select a user to message</h4>
                            <p>Choose a user from the list to start or continue a conversation</p>
                        </div>
                        
                        <div id="conversation-view" style="display: none;">
                            <div class="conversation-header">
                                <div class="conversation-user-info">
                                    <h4 id="conversation-user-name">User Name</h4>
                                    <span id="conversation-user-type" class="user-type-badge"></span>
                                </div>
                            </div>
                            
                            <div class="messages-list" id="messages-list">
                                <!-- Messages will be displayed here -->
                            </div>
                            
                            <div class="message-input-container">
                                <form id="message-form" class="message-form">
                                    <textarea id="message-text" placeholder="Type your message..." rows="3" required></textarea>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i>
                                        Send
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="profile-section">
                    <h3>Owner Profile & Settings</h3>
                    
                    <!-- Personal Information -->
                    <div class="profile-card">
                        <h4>Personal Information</h4>
                        <form class="profile-form" id="owner-profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="owner-profile-name">Full Name</label>
                                    <input type="text" id="owner-profile-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="owner-profile-email">Email</label>
                                    <input type="email" id="owner-profile-email" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="owner-profile-phone">Phone Number</label>
                                    <input type="tel" id="owner-profile-phone" required>
                                </div>
                                <div class="form-group">
                                    <label for="owner-profile-company">Company Name</label>
                                    <input type="text" id="owner-profile-company" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="owner-profile-bio">Description</label>
                                <textarea id="owner-profile-bio" rows="4" placeholder="Tell us about yourself..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </form>
                    </div>
                    
                    <!-- Security Settings -->
                    <div class="profile-card">
                        <h4>Security</h4>
                        <form class="profile-form" id="owner-password-form">
                            <div class="form-group">
                                <label for="owner-current-password">Current Password</label>
                                <input type="password" id="owner-current-password">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="owner-new-password">New Password</label>
                                    <input type="password" id="owner-new-password">
                                </div>
                                <div class="form-group">
                                    <label for="owner-confirm-password">Confirm New Password</label>
                                    <input type="password" id="owner-confirm-password">
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key"></i>
                                Change Password
                            </button>
                        </form>
                    </div>
                    
                    <!-- Account Actions -->
                    <div class="settings-grid">
                        <div class="setting-card">
                            <h4>Export Data</h4>
                            <p>Download all user data</p>
                            <button class="btn btn-outline btn-small" onclick="exportData()">Export</button>
                        </div>
                        <div class="setting-card">
                            <h4>Logout</h4>
                            <p>Sign out of owner dashboard</p>
                            <button class="btn btn-outline btn-small" onclick="logout()">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api';

        // Check if user is owner
        document.addEventListener('DOMContentLoaded', function() {
            const userType = localStorage.getItem('snackreach_user_type');
            const ownerName = localStorage.getItem('snackreach_user_name');
            
            if (userType !== 'owner') {
                alert('Access denied. Owner account required.');
                window.location.href = 'owner-login.html';
                return;
            }

            if (ownerName) {
                document.getElementById('owner-name').textContent = ownerName;
            }

            loadBankingInfo();
            loadAccounts();
            loadStats();
            loadOwnerProfile();
            
            // Set up message form
            document.getElementById('message-form').addEventListener('submit', sendMessage);
        });

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load users when messages tab is opened
            if (tabName === 'messages') {
                loadUsersForMessaging();
            }
        }
        
        let currentSelectedUserId = null;
        
        function loadUsersForMessaging() {
            const userList = document.getElementById('owner-user-list');
            userList.innerHTML = '';
            
            // Get all accounts
            const accounts = getAllAccountsFromStorage();
            
            // Filter out owner accounts
            const regularUsers = accounts.filter(acc => acc.userType !== 'owner');
            
            if (regularUsers.length === 0) {
                userList.innerHTML = '<div class="empty-state-small"><p>No users found</p></div>';
                return;
            }
            
            regularUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const lastMessage = getLastMessage(user.id);
                const unreadCount = getUnreadCount(user.id);
                
                userItem.innerHTML = `
                    <div class="user-item-info">
                        <h5>${user.name || user.companyName || 'Unknown User'}</h5>
                        <p class="user-item-type">${user.userType === 'startup' ? 'Snack Company' : 'Office Manager'}</p>
                        ${lastMessage ? `<p class="user-item-preview">${lastMessage.text.substring(0, 50)}${lastMessage.text.length > 50 ? '...' : ''}</p>` : '<p class="user-item-preview">No messages yet</p>'}
                    </div>
                    ${unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : ''}
                `;
                
                userItem.addEventListener('click', () => {
                    selectUserForMessaging(user, userItem);
                });
                
                userList.appendChild(userItem);
            });
        }
        
        function selectUserForMessaging(user, userItem) {
            currentSelectedUserId = user.id;
            
            // Update UI
            document.getElementById('no-conversation-selected').style.display = 'none';
            document.getElementById('conversation-view').style.display = 'block';
            document.getElementById('conversation-user-name').textContent = user.name || user.companyName || 'Unknown User';
            
            const userTypeBadge = document.getElementById('conversation-user-type');
            userTypeBadge.textContent = user.userType === 'startup' ? 'Snack Company' : 'Office Manager';
            userTypeBadge.className = 'user-type-badge ' + (user.userType === 'startup' ? 'startup' : 'office');
            
            // Load conversation
            loadConversation(user.id);
            
            // Highlight selected user
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('active');
            });
            if (userItem) {
                userItem.classList.add('active');
            }
        }
        
        function loadConversation(userId) {
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            
            // Get messages from localStorage
            const allMessages = JSON.parse(localStorage.getItem('snackreach_messages') || '[]');
            const ownerId = 'owner-' + (localStorage.getItem('snackreach_user_name') || 'admin');
            
            // Filter messages between owner and this user
            const conversationMessages = allMessages.filter(msg => 
                (msg.fromId === ownerId && msg.toId === userId) || 
                (msg.fromId === userId && msg.toId === ownerId)
            ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            if (conversationMessages.length === 0) {
                messagesList.innerHTML = '<div class="empty-state-small"><p>No messages yet. Start the conversation!</p></div>';
                return;
            }
            
            conversationMessages.forEach(msg => {
                const isOwner = msg.fromId === ownerId;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwner ? 'message-sent' : 'message-received'}`;
                
                const date = new Date(msg.timestamp);
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${msg.text}</p>
                        <span class="message-time">${date.toLocaleString()}</span>
                    </div>
                `;
                
                messagesList.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            messagesList.scrollTop = messagesList.scrollHeight;
            
            // Mark messages as read
            markMessagesAsRead(userId);
        }
        
        function sendMessage(e) {
            e.preventDefault();
            
            if (!currentSelectedUserId) {
                alert('Please select a user to message');
                return;
            }
            
            const messageText = document.getElementById('message-text').value.trim();
            if (!messageText) {
                return;
            }
            
            const ownerId = 'owner-' + (localStorage.getItem('snackreach_user_name') || 'admin');
            const ownerName = localStorage.getItem('snackreach_user_name') || 'SnackReach Admin';
            
            const message = {
                id: Date.now().toString(),
                fromId: ownerId,
                fromName: ownerName,
                toId: currentSelectedUserId,
                text: messageText,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            // Save to localStorage
            const allMessages = JSON.parse(localStorage.getItem('snackreach_messages') || '[]');
            allMessages.push(message);
            localStorage.setItem('snackreach_messages', JSON.stringify(allMessages));
            
            // Try to save to backend
            const token = localStorage.getItem('snackreach_token');
            if (token) {
                fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        toUserId: currentSelectedUserId,
                        text: messageText
                    })
                }).catch(error => {
                    console.log('Backend not available, saved locally');
                });
            }
            
            // Clear input
            document.getElementById('message-text').value = '';
            
            // Reload conversation
            loadConversation(currentSelectedUserId);
            
            // Refresh user list to show updated preview
            loadUsersForMessaging();
        }
        
        function getLastMessage(userId) {
            const allMessages = JSON.parse(localStorage.getItem('snackreach_messages') || '[]');
            const ownerId = 'owner-' + (localStorage.getItem('snackreach_user_name') || 'admin');
            
            const conversationMessages = allMessages.filter(msg => 
                (msg.fromId === ownerId && msg.toId === userId) || 
                (msg.fromId === userId && msg.toId === ownerId)
            ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            return conversationMessages.length > 0 ? conversationMessages[0] : null;
        }
        
        function getUnreadCount(userId) {
            const allMessages = JSON.parse(localStorage.getItem('snackreach_messages') || '[]');
            const ownerId = 'owner-' + (localStorage.getItem('snackreach_user_name') || 'admin');
            
            return allMessages.filter(msg => 
                msg.fromId === userId && 
                msg.toId === ownerId && 
                !msg.read
            ).length;
        }
        
        function markMessagesAsRead(userId) {
            const allMessages = JSON.parse(localStorage.getItem('snackreach_messages') || '[]');
            const ownerId = 'owner-' + (localStorage.getItem('snackreach_user_name') || 'admin');
            
            allMessages.forEach(msg => {
                if (msg.fromId === userId && msg.toId === ownerId && !msg.read) {
                    msg.read = true;
                }
            });
            
            localStorage.setItem('snackreach_messages', JSON.stringify(allMessages));
        }
        
        function startNewMessage() {
            // For now, just show the user list
            // Could add a modal to search/select user in the future
            loadUsersForMessaging();
        }

        function loadBankingInfo() {
            const ownerData = JSON.parse(localStorage.getItem('snackreach_owner_data') || '{}');
            
            if (ownerData.bankingInfo) {
                document.getElementById('bank-name-display').textContent = ownerData.bankingInfo.bankName || '-';
                document.getElementById('account-name-display').textContent = ownerData.bankingInfo.accountName || '-';
                document.getElementById('account-number-display').textContent = ownerData.bankingInfo.accountNumber ? '****' + ownerData.bankingInfo.accountNumber.slice(-4) : '-';
                document.getElementById('routing-number-display').textContent = ownerData.bankingInfo.routingNumber ? '****' + ownerData.bankingInfo.routingNumber.slice(-4) : '-';
                
                const address = [
                    ownerData.bankingInfo.address,
                    ownerData.bankingInfo.city,
                    ownerData.bankingInfo.state,
                    ownerData.bankingInfo.zip
                ].filter(Boolean).join(', ');
                
                document.getElementById('bank-address-display').textContent = address || '-';
            }
        }

        async function loadAccounts() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/all-accounts`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('snackreach_token')}`
                    }
                });
                const accounts = await response.json();
                displayAccounts(accounts);
            } catch (error) {
                // Fallback to localStorage
                const accounts = getAllAccountsFromStorage();
                displayAccounts(accounts);
            }
        }

        function getAllAccountsFromStorage() {
            const accounts = [];
            
            // Get owner accounts
            const ownerData = JSON.parse(localStorage.getItem('snackreach_owner_data') || '{}');
            if (ownerData.id) {
                accounts.push({
                    id: ownerData.id,
                    name: ownerData.name,
                    email: ownerData.email,
                    companyName: ownerData.companyName,
                    userType: 'owner',
                    createdAt: ownerData.createdAt
                });
            }
            
            // Get regular user accounts from localStorage
            const regularUsers = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            regularUsers.forEach(user => {
                accounts.push({
                    id: user.id,
                    name: user.name,
                    email: user.email,
                    companyName: user.companyName,
                    userType: user.userType,
                    createdAt: user.createdAt
                });
            });
            
            return accounts;
        }

        function displayAccounts(accounts) {
            const tbody = document.getElementById('accounts-table-body');
            
            if (accounts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 2rem;">
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h4>No accounts yet</h4>
                                <p>User accounts will appear here once they sign up</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = accounts.map(account => `
                <tr>
                    <td>${account.name}</td>
                    <td>${account.email}</td>
                    <td>${account.companyName || '-'}</td>
                    <td><span class="status-badge ${account.userType}">${account.userType}</span></td>
                    <td><span class="status-badge active">Active</span></td>
                    <td>${new Date(account.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-outline btn-small">
                            <i class="fas fa-eye"></i>
                            View
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function loadStats() {
            const accounts = getAllAccountsFromStorage();
            const startups = accounts.filter(a => a.userType === 'startup');
            const offices = accounts.filter(a => a.userType === 'office');
            
            document.getElementById('total-users').textContent = accounts.length;
            document.getElementById('total-startups').textContent = startups.length;
            document.getElementById('total-offices').textContent = offices.length;
        }

        function editBankingInfo() {
            document.getElementById('banking-details').style.display = 'none';
            document.getElementById('banking-form').style.display = 'block';
            switchPaymentType('card');
        }

        function cancelEditBanking() {
            document.getElementById('banking-details').style.display = 'block';
            document.getElementById('banking-form').style.display = 'none';
            // Reset forms
            document.getElementById('card-payment-form-owner').reset();
            document.getElementById('bank-payment-form-owner').reset();
        }

        function switchPaymentType(type) {
            const cardForm = document.getElementById('card-payment-form-owner');
            const bankForm = document.getElementById('bank-payment-form-owner');
            const cardTab = document.querySelectorAll('.payment-tab-btn')[0];
            const bankTab = document.querySelectorAll('.payment-tab-btn')[1];
            
            if (type === 'card') {
                cardForm.style.display = 'block';
                bankForm.style.display = 'none';
                cardTab.classList.add('active');
                bankTab.classList.remove('active');
            } else {
                cardForm.style.display = 'none';
                bankForm.style.display = 'block';
                cardTab.classList.remove('active');
                bankTab.classList.add('active');
            }
        }

        // Handle "Other" bank selection
        document.getElementById('bank-name-owner').addEventListener('change', function() {
            const otherInput = document.getElementById('other-bank-input-owner');
            if (this.value === 'other') {
                otherInput.style.display = 'block';
                document.getElementById('other-bank-name-owner').required = true;
            } else {
                otherInput.style.display = 'none';
                document.getElementById('other-bank-name-owner').required = false;
            }
        });

        // Format card number with spaces
        document.getElementById('card-number-owner').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue.length <= 19) {
                e.target.value = formattedValue;
            }
        });

        // Card form submission
        document.getElementById('card-payment-form-owner').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ownerData = JSON.parse(localStorage.getItem('snackreach_owner_data') || '{}');
            
            if (!ownerData.paymentMethods) {
                ownerData.paymentMethods = [];
            }
            
            const cardData = {
                id: Date.now().toString(),
                type: 'card',
                cardType: document.getElementById('card-type-owner').value,
                last4: document.getElementById('card-number-owner').value.slice(-4),
                expiry: document.getElementById('card-expiry-owner').value,
                name: document.getElementById('card-name-owner').value,
                isDefault: document.getElementById('set-default-card-owner').checked || !ownerData.paymentMethods.length
            };
            
            // If setting as default, unset others
            if (cardData.isDefault) {
                ownerData.paymentMethods.forEach(pm => pm.isDefault = false);
            }
            
            ownerData.paymentMethods.push(cardData);
            localStorage.setItem('snackreach_owner_data', JSON.stringify(ownerData));
            
            alert('Credit card added successfully!');
            cancelEditBanking();
            loadBankingInfo();
        });

        // Bank form submission
        document.getElementById('bank-payment-form-owner').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const ownerData = JSON.parse(localStorage.getItem('snackreach_owner_data') || '{}');
            
            if (!ownerData.paymentMethods) {
                ownerData.paymentMethods = [];
            }
            
            const bankName = document.getElementById('bank-name-owner').value === 'other' 
                ? document.getElementById('other-bank-name-owner').value 
                : document.getElementById('bank-name-owner').value;
            
            const bankData = {
                id: Date.now().toString(),
                type: 'bank',
                bankName: bankName,
                accountType: document.getElementById('account-type-owner').value,
                last4: document.getElementById('account-number-owner').value.slice(-4),
                accountHolder: document.getElementById('account-holder-name-owner').value,
                isDefault: document.getElementById('set-default-bank-owner').checked || !ownerData.paymentMethods.length
            };
            
            // If setting as default, unset others
            if (bankData.isDefault) {
                ownerData.paymentMethods.forEach(pm => pm.isDefault = false);
            }
            
            ownerData.paymentMethods.push(bankData);
            localStorage.setItem('snackreach_owner_data', JSON.stringify(ownerData));
            
            alert('Bank account linked successfully!');
            cancelEditBanking();
            loadBankingInfo();
        });

        function loadOwnerProfile() {
            const ownerData = JSON.parse(localStorage.getItem('snackreach_owner_data') || '{}');
            const storedName = localStorage.getItem('snackreach_user_name');
            const storedCompany = localStorage.getItem('snackreach_company_name');
            
            document.getElementById('owner-profile-name').value = ownerData.name || storedName || '';
            document.getElementById('owner-profile-email').value = ownerData.email || '';
            document.getElementById('owner-profile-phone').value = ownerData.phone || '';
            document.getElementById('owner-profile-company').value = ownerData.companyName || storedCompany || '';
            document.getElementById('owner-profile-bio').value = ownerData.bio || '';
        }

        // Save owner profile
        document.getElementById('owner-profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('owner-profile-name').value;
            const email = document.getElementById('owner-profile-email').value;
            const phone = document.getElementById('owner-profile-phone').value;
            const company = document.getElementById('owner-profile-company').value;
            const bio = document.getElementById('owner-profile-bio').value;
            
            const ownerData = JSON.parse(localStorage.getItem('snackreach_owner_data') || '{}');
            
            ownerData.name = name;
            ownerData.email = email;
            ownerData.phone = phone;
            ownerData.companyName = company;
            ownerData.bio = bio;
            
            localStorage.setItem('snackreach_owner_data', JSON.stringify(ownerData));
            localStorage.setItem('snackreach_user_name', name);
            localStorage.setItem('snackreach_company_name', company);
            
            // Update navbar
            document.getElementById('owner-name').textContent = name;
            
            // Try to save to backend
            try {
                await fetch(`${API_BASE_URL}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('snackreach_token')}`
                    },
                    body: JSON.stringify({ name, email, phone, companyName: company })
                });
            } catch (error) {
                console.log('Backend not available, saved locally');
            }
            
            alert('Profile updated successfully!');
        });

        // Change password
        document.getElementById('owner-password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('owner-new-password').value;
            const confirmPassword = document.getElementById('owner-confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            const ownerData = JSON.parse(localStorage.getItem('snackreach_owner_data') || '{}');
            ownerData.password = newPassword; // In real app, this would be hashed
            localStorage.setItem('snackreach_owner_data', JSON.stringify(ownerData));
            
            document.getElementById('owner-password-form').reset();
            alert('Password changed successfully!');
        });

        function exportData() {
            const accounts = getAllAccountsFromStorage();
            const dataStr = JSON.stringify(accounts, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `snackreach-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('snackreach_token');
                localStorage.removeItem('snackreach_user_type');
                localStorage.removeItem('snackreach_user_name');
                localStorage.removeItem('snackreach_company_name');
                window.location.href = 'owner-login.html';
            }
        }
    </script>
    <style>
        .accounts-table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .accounts-table {
            width: 100%;
            border-collapse: collapse;
        }
        .accounts-table thead {
            background: #f8fafc;
        }
        .accounts-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #1e293b;
            border-bottom: 2px solid #e5e7eb;
        }
        .accounts-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .accounts-table tbody tr:hover {
            background: #f8fafc;
        }
        .account-filters {
            display: flex;
            gap: 1rem;
        }
        .account-filters select,
        .account-filters input {
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
        }
        .banking-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .banking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .banking-details {
            display: grid;
            gap: 1rem;
        }
        .detail-row {
            display: flex;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .detail-label {
            font-weight: 600;
            color: #64748b;
            min-width: 150px;
        }
        .detail-value {
            color: #1e293b;
        }
        .banking-form {
            background: #f8fafc;
            padding: 2rem;
            border-radius: 16px;
            margin-top: 2rem;
        }
        .section-description {
            color: #64748b;
            margin-bottom: 2rem;
        }
        .status-badge.owner {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
        }
        .status-badge.startup {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }
        .status-badge.office {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
    </style>
</body>
</html>

