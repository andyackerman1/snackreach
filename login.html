<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SnackReach</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-utensils"></i>
                <span>SnackReach</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Back to Home</a>
            </div>
        </div>
    </nav>

    <!-- Login Section -->
    <section class="signup-section">
        <div class="container">
            <div class="signup-container">
                <div class="signup-header">
                    <h1>Welcome Back</h1>
                    <p>Sign in to your SnackReach account</p>
                </div>

                <form id="login-form" class="signup-form">
                    <div class="form-header">
                        <h2>Login to Your Account</h2>
                        <p>Enter your credentials to access your dashboard</p>
                    </div>
                    
                    <div id="login-error" class="error-message" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" required>
                        <div class="password-toggle" onclick="togglePassword('login-password')">
                            <i class="fas fa-eye" id="login-password-eye"></i>
                        </div>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="remember-me">
                        <label for="remember-me">Remember me</label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                    
                    <div class="form-footer">
                        <p>Don't have an account? <a href="signup.html">Sign up here</a></p>
                        <p><a href="#" onclick="bypassLogin(); return false;" style="color: #dc2626; font-size: 0.9rem;">Quick Demo Access</a></p>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <script src="js/api.js"></script>
    <script>
        // Check if already logged in - if so, redirect to dashboard
        // Sessions persist until explicit logout
        function checkLoginStatus() {
            const token = localStorage.getItem('snackreach_token');
            const userType = localStorage.getItem('snackreach_user_type');
            
            if (token && userType) {
                // User is already logged in - redirect to their dashboard
                if (userType === 'owner') {
                    window.location.href = 'owner-dashboard.html';
                } else if (userType === 'startup') {
                    window.location.href = 'snack-dashboard.html';
                } else if (userType === 'office') {
                    window.location.href = 'office-dashboard.html';
                }
            }
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const eye = document.getElementById(inputId + '-eye');
            
            if (input.type === 'password') {
                input.type = 'text';
                eye.classList.remove('fa-eye');
                eye.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                eye.classList.remove('fa-eye-slash');
                eye.classList.add('fa-eye');
            }
        }

        // Bypass login for demo
        function bypassLogin() {
            // Set demo credentials
            localStorage.setItem('snackreach_token', 'demo-token');
            localStorage.setItem('snackreach_user_type', 'startup');
            localStorage.setItem('snackreach_user_name', 'Demo User');
            localStorage.setItem('snackreach_company_name', 'Demo Snack Company');
            
            alert('Demo login activated! Redirecting to dashboard...');
            window.location.href = 'snack-dashboard.html';
        }

        // Handle login form submission
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            // Clear previous errors
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                // Try backend login first
                const API_BASE_URL = (() => {
                    const hostname = window.location.hostname;
                    if (hostname.includes('railway.app')) {
                        return '/api';
                    } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                        return 'https://snackreach-production.up.railway.app/api';
                    } else {
                        return 'http://localhost:3000/api';
                    }
                })();

                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();

                if (response.ok && data.token) {
                    // Success - save token and user info
                    localStorage.setItem('snackreach_token', data.token);
                    localStorage.setItem('snackreach_user_type', data.user.userType);
                    localStorage.setItem('snackreach_user_name', data.user.name);
                    localStorage.setItem('snackreach_company_name', data.user.companyName || data.user.name);
                    
                    // Also save to users array in localStorage
                    const users = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
                    const userIndex = users.findIndex(u => u.email === email);
                    if (userIndex !== -1) {
                        users[userIndex] = {
                            ...users[userIndex],
                            ...data.user,
                            password: password // In real app, never store plain password
                        };
                    } else {
                        users.push({
                            ...data.user,
                            password: password,
                            email: email
                        });
                    }
                    localStorage.setItem('snackreach_users', JSON.stringify(users));
                    
                    // Redirect based on user type
                    if (data.user.userType === 'owner') {
                        window.location.href = 'owner-dashboard.html';
                    } else if (data.user.userType === 'startup') {
                        window.location.href = 'snack-dashboard.html';
                    } else if (data.user.userType === 'office') {
                        window.location.href = 'office-dashboard.html';
                    } else {
                        window.location.href = 'snack-dashboard.html';
                    }
                } else {
                    // Try localStorage fallback
                    const users = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
                    const user = users.find(u => u.email === email);
                    
                    if (user && user.password === password) {
                        // Local login successful
                        localStorage.setItem('snackreach_token', 'local-token-' + Date.now());
                        localStorage.setItem('snackreach_user_type', user.userType || 'startup');
                        localStorage.setItem('snackreach_user_name', user.name);
                        localStorage.setItem('snackreach_company_name', user.companyName || user.name);
                        
                        // Redirect
                        if (user.userType === 'owner') {
                            window.location.href = 'owner-dashboard.html';
                        } else if (user.userType === 'office') {
                            window.location.href = 'office-dashboard.html';
                        } else {
                            window.location.href = 'snack-dashboard.html';
                        }
                    } else {
                        // Show error
                        errorDiv.textContent = data.error || 'Invalid email or password. Please try again.';
                        errorDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Try localStorage fallback
                const users = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
                const user = users.find(u => u.email === email);
                
                if (user && user.password === password) {
                    // Local login successful
                    localStorage.setItem('snackreach_token', 'local-token-' + Date.now());
                    localStorage.setItem('snackreach_user_type', user.userType || 'startup');
                    localStorage.setItem('snackreach_user_name', user.name);
                    localStorage.setItem('snackreach_company_name', user.companyName || user.name);
                    
                    // Redirect
                    if (user.userType === 'owner') {
                        window.location.href = 'owner-dashboard.html';
                    } else if (user.userType === 'office') {
                        window.location.href = 'office-dashboard.html';
                    } else {
                        window.location.href = 'snack-dashboard.html';
                    }
                } else {
                    errorDiv.textContent = 'Unable to connect to server. Please check your connection or try again later.';
                    errorDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
        });

        // Check login status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html>

