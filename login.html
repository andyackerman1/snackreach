<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - SnackReach</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Clerk JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-utensils"></i>
                <span>SnackReach</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Back to Home</a>
            </div>
        </div>
    </nav>

    <!-- Login Section -->
    <section class="signup-section">
        <div class="container">
            <div class="signup-container">
                <div class="signup-header">
                    <h1>Welcome Back</h1>
                    <p>Sign in to your SnackReach account</p>
                </div>

                <form id="login-form" class="signup-form">
                    <div class="form-header">
                        <h2>Login to Your Account</h2>
                        <p>Enter your credentials to access your dashboard</p>
                    </div>
                    
                    <div id="login-error" class="error-message" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" placeholder="Enter your password" required>
                        <div class="password-toggle" onclick="togglePassword('login-password')">
                            <i class="fas fa-eye" id="login-password-eye"></i>
                        </div>
                    </div>
                    
                    <div class="form-group" style="text-align: right; margin-top: -10px;">
                        <a href="#" onclick="showForgotPasswordModal(); return false;" style="color: #667eea; text-decoration: none; font-size: 0.9rem;">
                            Forgot Password?
                        </a>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="remember-me">
                        <label for="remember-me">Remember me</label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                    
                    <div class="form-footer">
                        <p>Don't have an account? <a href="signup.html">Sign up here</a></p>
                        <p><a href="#" onclick="bypassLogin(); return false;" style="color: #dc2626; font-size: 0.9rem;">Quick Demo Access</a></p>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reset Password</h2>
                <button class="modal-close" onclick="closeForgotPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Enter your email address and we'll send you a link to reset your password.</p>
                <div id="forgot-password-error" class="error-message" style="display: none; margin-bottom: 15px;"></div>
                <div id="forgot-password-success" class="success-message" style="display: none; margin-bottom: 15px;"></div>
                <form id="forgot-password-form">
                    <div class="form-group">
                        <label for="forgot-email">Email Address</label>
                        <input type="email" id="forgot-email" placeholder="Enter your email" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-paper-plane"></i>
                        Send Reset Link
                    </button>
                </form>
            </div>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 0;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body p {
            color: #6b7280;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .success-message {
            background-color: #d1fae5;
            color: #065f46;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #a7f3d0;
            font-size: 0.9rem;
        }
    </style>

    <script src="js/api.js"></script>
    <script>
        // Clerk Configuration
        const CLERK_PUBLISHABLE_KEY = 'pk_test_cHJldHR5LXRyZWVmcm9nLTg4LmNsZXJrLmFjY291bnRzLmRldiQ';
        let clerk = null;

        // Initialize Clerk
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                clerk = new Clerk(CLERK_PUBLISHABLE_KEY);
                await clerk.load();
                
                // Check if user is already signed in
                if (clerk.user) {
                    await handleClerkSignIn(clerk.user);
                }
            } catch (error) {
                console.error('Clerk initialization error:', error);
            }
        });

        // Check if already logged in - if so, redirect to dashboard
        function checkLoginStatus() {
            const token = localStorage.getItem('snackreach_token');
            const userType = localStorage.getItem('snackreach_user_type');
            
            if (token && userType) {
                // User is already logged in - redirect to their dashboard
                if (userType === 'owner') {
                    window.location.href = 'owner-dashboard.html';
                } else if (userType === 'startup') {
                    window.location.href = 'snack-dashboard.html';
                } else if (userType === 'office') {
                    window.location.href = 'office-dashboard.html';
                }
            }
        }

        // Handle Clerk sign-in and get user data
        async function handleClerkSignIn(user) {
            try {
                // Get session token from Clerk
                const session = await clerk.session;
                if (!session) {
                    return;
                }

                const sessionToken = await session.getToken();
                
                // Get user data from backend
                const API_BASE_URL = (() => {
                    const hostname = window.location.hostname;
                    if (hostname.includes('railway.app')) {
                        return '/api';
                    } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                        return 'https://snackreach-production.up.railway.app/api';
                    } else {
                        return 'http://localhost:3000/api';
                    }
                })();

                // Get user profile from backend
                const response = await fetch(`${API_BASE_URL}/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    const userData = data.user;
                    
                    // Store user info
                    localStorage.setItem('snackreach_token', sessionToken);
                    localStorage.setItem('snackreach_user_type', userData.userType || 'office');
                    localStorage.setItem('snackreach_user_name', userData.name || user.emailAddresses[0]?.emailAddress || 'User');
                    localStorage.setItem('snackreach_company_name', userData.companyName || '');
                    
                    // Redirect based on user type
                    if (userData.userType === 'owner') {
                        window.location.href = 'owner-dashboard.html';
                    } else if (userData.userType === 'startup') {
                        window.location.href = 'snack-dashboard.html';
                    } else if (userData.userType === 'office') {
                        window.location.href = 'office-dashboard.html';
                    } else {
                        window.location.href = 'snack-dashboard.html';
                    }
                }
            } catch (error) {
                console.error('Error handling Clerk sign-in:', error);
            }
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const eye = document.getElementById(inputId + '-eye');
            
            if (input.type === 'password') {
                input.type = 'text';
                eye.classList.remove('fa-eye');
                eye.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                eye.classList.remove('fa-eye-slash');
                eye.classList.add('fa-eye');
            }
        }

        // Bypass login for demo
        function bypassLogin() {
            // Set demo credentials
            localStorage.setItem('snackreach_token', 'demo-token');
            localStorage.setItem('snackreach_user_type', 'startup');
            localStorage.setItem('snackreach_user_name', 'Demo User');
            localStorage.setItem('snackreach_company_name', 'Demo Snack Company');
            
            alert('Demo login activated! Redirecting to dashboard...');
            window.location.href = 'snack-dashboard.html';
        }

        // Handle login form submission using Clerk
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            
            // Clear previous errors
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                // Wait for Clerk to be loaded
                if (!clerk) {
                    clerk = new Clerk(CLERK_PUBLISHABLE_KEY);
                    await clerk.load();
                }

                // Sign in using Clerk
                const signInAttempt = await clerk.client.signIn.create({
                    identifier: email,
                    password: password,
                });

                // Complete the sign-in
                const signInResult = await signInAttempt.attemptPassword({
                    password: password,
                });

                if (signInResult.status === 'complete') {
                    // Get the session
                    const session = signInResult.createdSessionId 
                        ? await clerk.client.sessions.get(signInResult.createdSessionId)
                        : await clerk.session;
                    
                    if (session) {
                        const sessionToken = await session.getToken();
                        await handleClerkSignIn(clerk.user);
                    } else {
                        throw new Error('Failed to create session');
                    }
                } else {
                    throw new Error('Sign-in incomplete');
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Show user-friendly error
                let errorMessage = 'Invalid email or password. Please try again.';
                if (error.errors && error.errors.length > 0) {
                    errorMessage = error.errors[0].message || errorMessage;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Forgot Password Modal Functions
        function showForgotPasswordModal() {
            document.getElementById('forgot-password-modal').style.display = 'flex';
            document.getElementById('forgot-email').focus();
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgot-password-modal').style.display = 'none';
            document.getElementById('forgot-password-form').reset();
            document.getElementById('forgot-password-error').style.display = 'none';
            document.getElementById('forgot-password-success').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('forgot-password-modal');
            if (event.target === modal) {
                closeForgotPasswordModal();
            }
        }

        // Handle forgot password form submission
        document.getElementById('forgot-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('forgot-email').value;
            const errorDiv = document.getElementById('forgot-password-error');
            const successDiv = document.getElementById('forgot-password-success');
            const submitBtn = this.querySelector('button[type="submit"]');
            
            // Clear previous messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            errorDiv.textContent = '';
            successDiv.textContent = '';
            
            // Show loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            
            try {
                // Dynamic API URL detection
                const API_BASE_URL = (() => {
                    const hostname = window.location.hostname;
                    if (hostname.includes('railway.app')) {
                        return '/api';
                    } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                        return 'https://snackreach-production.up.railway.app/api';
                    } else {
                        return 'http://localhost:3000/api';
                    }
                })();

                const response = await fetch(`${API_BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success message
                    let message = data.message || 'Password reset link sent! Check your email.';
                    
                    // If reset link is provided (development mode), make it clickable
                    if (data.resetLink) {
                        message = `Password reset link generated! <a href="${data.resetLink}" target="_blank" style="color: #667eea; text-decoration: underline; font-weight: 600;">Click here to reset your password</a>`;
                    }
                    
                    successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
                    successDiv.style.display = 'block';
                    
                    // Reset form
                    this.reset();
                    
                    // Close modal after 5 seconds (longer if link is shown)
                    setTimeout(() => {
                        closeForgotPasswordModal();
                    }, data.resetLink ? 10000 : 3000);
                } else {
                    // Show error
                    errorDiv.textContent = data.error || 'Failed to send reset link. Please try again.';
                    errorDiv.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Forgot password error:', error);
                errorDiv.textContent = 'Unable to connect to server. Please check your connection or try again later.';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Check login status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
    </script>
</body>
</html>

