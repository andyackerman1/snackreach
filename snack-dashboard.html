<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnackReach - Snack Company Dashboard</title>
    <script>
        (function redirectToReactDashboard() {
            if (typeof window !== "undefined") {
                window.location.replace("/dashboard");
            }
        })();
    </script>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="js/plaid-link.js"></script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <i class="fas fa-utensils"></i>
                <span>SnackReach</span>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link">Back to Home</a>
                <div class="user-info">
                    <span class="user-name" id="user-name">Crunchy Greens</span>
                    <span class="subscription-badge">Free</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header">
                <h1>Snack Company Dashboard</h1>
                <p>Manage your brand awareness campaigns and connect with offices</p>
            </div>

            <!-- Dashboard Tabs -->
            <div class="dashboard-tabs">
                <button class="tab-btn active" onclick="showTab('overview')">
                    <i class="fas fa-chart-line"></i>
                    Overview
                </button>
                <button class="tab-btn" onclick="showTab('discover')">
                    <i class="fas fa-search"></i>
                    Discover Offices
                </button>
                <button class="tab-btn" onclick="showTab('offices')">
                    <i class="fas fa-building"></i>
                    My Connections
                </button>
                <button class="tab-btn" onclick="showTab('orders')">
                    <i class="fas fa-shopping-cart"></i>
                    Orders
                </button>
                <button class="tab-btn" onclick="showTab('messages')">
                    <i class="fas fa-comments"></i>
                    Messages
                    <span class="message-limit">5/10 today</span>
                </button>
                <button class="tab-btn" onclick="showTab('account')">
                    <i class="fas fa-cog"></i>
                    Account
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="stat-info">
                            <h3>0</h3>
                            <p>Office Connections</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="stat-info">
                            <h3>0</h3>
                            <p>Total Orders</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3>0</h3>
                            <p>Office Workers Reached</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="stat-info">
                            <h3>$0</h3>
                            <p>Revenue Generated</p>
                        </div>
                    </div>
                </div>

                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h4>No activity yet</h4>
                        <p>Your recent activity will appear here once you start connecting with offices.</p>
                    </div>
                </div>
            </div>

            <!-- Discover Tab -->
            <div id="discover-tab" class="tab-content">
                <div class="section-header">
                    <h3>Discover Office Spaces</h3>
                    <p>Find offices that match your target audience and reach out to them</p>
                </div>
                
                <div class="discover-filters">
                    <div class="filter-group">
                        <label>Company Size</label>
                        <select>
                            <option value="">All Sizes</option>
                            <option value="small">1-25 employees</option>
                            <option value="medium">26-100 employees</option>
                            <option value="large">100+ employees</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Industry</label>
                        <select>
                            <option value="">All Industries</option>
                            <option value="tech">Technology</option>
                            <option value="finance">Finance</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="creative">Creative</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Location</label>
                        <select>
                            <option value="">All Locations</option>
                            <option value="sf">San Francisco</option>
                            <option value="ny">New York</option>
                            <option value="la">Los Angeles</option>
                            <option value="remote">Remote</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" placeholder="Search offices...">
                    </div>
                </div>
                
                <div id="offices-list-container">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <h4>Loading offices...</h4>
                        <p>Finding office spaces you can connect with.</p>
                    </div>
                </div>
            </div>

            <!-- Office Spaces Tab -->
            <div id="offices-tab" class="tab-content">
                <div class="section-header">
                    <h3>Connected Office Spaces</h3>
                    <button class="btn btn-primary btn-small">
                        <i class="fas fa-plus"></i>
                        Add New Office
                    </button>
                </div>
                
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h4>No office connections yet</h4>
                    <p>Start connecting with offices to build your brand awareness. Offices will appear here once they show interest in your products.</p>
                    <button class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        Add New Office
                    </button>
                </div>
            </div>

            <!-- Previous Orders Tab -->
            <div id="orders-tab" class="tab-content">
                <div class="section-header">
                    <h3>Previous Orders</h3>
                    <div class="order-filters">
                        <select>
                            <option>All Orders</option>
                            <option>This Month</option>
                            <option>Last 3 Months</option>
                        </select>
                    </div>
                </div>
                
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h4>No orders yet</h4>
                    <p>Your order history will appear here once offices start placing orders for your products.</p>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages-tab" class="tab-content">
                <div class="section-header">
                    <h3>Messages</h3>
                    <button class="btn btn-primary btn-small" onclick="showNewMessageModal()">
                        <i class="fas fa-plus"></i>
                        New Message
                    </button>
                </div>
                
                <div id="messages-container">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h4>No messages yet</h4>
                        <p>Start a conversation with an office or view messages from office managers.</p>
                    </div>
                </div>
            </div>
            
            <!-- New Message Modal -->
            <div id="new-message-modal" class="modal" style="display: none;">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h2>New Message</h2>
                        <span class="close" onclick="closeModal('new-message-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="new-message-form">
                            <div class="form-group">
                                <label for="message-to">To (Office)</label>
                                <select id="message-to" required>
                                    <option value="">Select an office...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="message-subject">Subject</label>
                                <input type="text" id="message-subject" placeholder="Enter message subject" required>
                            </div>
                            <div class="form-group">
                                <label for="message-body">Message</label>
                                <textarea id="message-body" rows="6" placeholder="Enter your message here..." required></textarea>
                            </div>
                            <div id="message-error" class="error-message" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: #fee2e2; color: #dc2626; border-radius: 6px;"></div>
                            <div class="modal-actions">
                                <button type="button" class="btn btn-outline" onclick="closeModal('new-message-modal')">Cancel</button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i>
                                    Send Message
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Account Tab -->
            <div id="account-tab" class="tab-content">
                <div class="profile-section">
                    <h3>Profile & Account Settings</h3>
                    
                    <!-- Personal Information -->
                    <div class="profile-card">
                        <h4>Personal Information</h4>
                        <form class="profile-form" id="snack-profile-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="profile-name">Full Name</label>
                                    <input type="text" id="profile-name" required>
                                </div>
                                <div class="form-group">
                                    <label for="profile-email">Email</label>
                                    <input type="email" id="profile-email" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="profile-phone">Phone Number</label>
                                    <input type="tel" id="profile-phone" required>
                                </div>
                                <div class="form-group">
                                    <label for="profile-company">Company Name</label>
                                    <input type="text" id="profile-company" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="profile-bio">Company Bio</label>
                                <textarea id="profile-bio" rows="4" placeholder="Tell us about your company..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Save Changes
                            </button>
                        </form>
                    </div>
                    
                    <!-- Password Change -->
                    <div class="profile-card">
                        <h4>Change Password</h4>
                        <form class="profile-form" id="snack-password-form">
                            <div class="form-group">
                                <label for="snack-current-password">Current Password</label>
                                <input type="password" id="snack-current-password">
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="snack-new-password">New Password</label>
                                    <input type="password" id="snack-new-password">
                                </div>
                                <div class="form-group">
                                    <label for="snack-confirm-password">Confirm New Password</label>
                                    <input type="password" id="snack-confirm-password">
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key"></i>
                                Change Password
                            </button>
                        </form>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="profile-card">
                        <div class="section-header-with-action">
                            <h4>Payment Methods</h4>
                            <button class="btn btn-primary btn-small" onclick="showAddPaymentModal()">
                                <i class="fas fa-plus"></i>
                                Add Payment Method
                            </button>
                        </div>
                        <div id="payment-methods-list" class="payment-methods-list">
                            <!-- Payment methods will be loaded here -->
                        </div>
                        <div id="no-payment-methods" class="empty-state-small" style="display: none;">
                            <p>No payment methods added yet. Add one to get started.</p>
                        </div>
                    </div>
                    
                    
                    <!-- Account Actions -->
                    <div class="profile-card">
                        <h4>Account Actions</h4>
                        <div class="account-actions">
                            <div class="action-item">
                                <div class="action-info">
                                    <h5>Change Password</h5>
                                    <p>Update your account password</p>
                                </div>
                                <button class="btn btn-outline btn-small">
                                    <i class="fas fa-key"></i>
                                    Change Password
                                </button>
                            </div>
                            
                            <div class="action-item">
                                <div class="action-info">
                                    <h5>Download Data</h5>
                                    <p>Export your account data</p>
                                </div>
                                <button class="btn btn-outline btn-small">
                                    <i class="fas fa-download"></i>
                                    Download
                                </button>
                            </div>
                            
                            <div class="action-item">
                                <div class="action-info">
                                    <h5>Delete Account</h5>
                                    <p>Permanently delete your account</p>
                                </div>
                                <button class="btn btn-outline btn-small" style="color: #dc2626; border-color: #dc2626;" onclick="deleteAccount()">
                                    <i class="fas fa-trash"></i>
                                    Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Logout Section -->
                    <div class="logout-section">
                        <button class="btn btn-primary btn-large" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Log Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Add Payment Method Modal -->
    <div id="add-payment-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2>Add Payment Method</h2>
                <span class="close" onclick="closeModal('add-payment-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="payment-type-tabs">
                    <button class="payment-tab-btn active" onclick="switchPaymentType('card')">
                        <i class="fas fa-credit-card"></i>
                        Credit/Debit Card
                    </button>
                    <button class="payment-tab-btn" onclick="switchPaymentType('bank')">
                        <i class="fas fa-university"></i>
                        Bank Account
                    </button>
                </div>
                
                <!-- Credit Card Form -->
                <form id="card-payment-form" class="payment-form">
                    <div class="form-group">
                        <label for="card-type">Card Type</label>
                        <select id="card-type" required>
                            <option value="">Select card type...</option>
                            <option value="visa">Visa</option>
                            <option value="mastercard">Mastercard</option>
                            <option value="amex">American Express</option>
                            <option value="discover">Discover</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="card-number-new">Card Number</label>
                        <input type="text" id="card-number-new" placeholder="1234 5678 9012 3456" maxlength="19" required>
                    </div>
                    <script>
                        // Format card number with spaces
                        document.getElementById('card-number-new').addEventListener('input', function(e) {
                            let value = e.target.value.replace(/\s/g, '');
                            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                            if (formattedValue.length <= 19) {
                                e.target.value = formattedValue;
                            }
                        });
                    </script>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-expiry-new">Expiry Date</label>
                            <input type="text" id="card-expiry-new" placeholder="MM/YY" maxlength="5" required>
                        </div>
                        <div class="form-group">
                            <label for="card-cvv-new">CVV</label>
                            <input type="text" id="card-cvv-new" placeholder="123" maxlength="4" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="card-name-new">Name on Card</label>
                        <input type="text" id="card-name-new" placeholder="John Doe" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="card-billing-address">Billing Address</label>
                        <input type="text" id="card-billing-address" placeholder="123 Main St, City, State 12345" required>
                    </div>
                    
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="set-default-card">
                        <label for="set-default-card">Set as default payment method</label>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-outline" onclick="closeModal('add-payment-modal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-lock"></i>
                            Add Card
                        </button>
                    </div>
                </form>
                
                <!-- Bank Account Form - Using Plaid Link -->
                <div id="bank-payment-form" class="payment-form" style="display: none;">
                    <div class="plaid-link-container">
                        <div class="security-info">
                            <i class="fas fa-shield-alt"></i>
                            <h4>Secure Bank Verification</h4>
                            <p>We use Plaid to securely connect your bank account. Your bank credentials are never stored on our servers.</p>
                        </div>
                        
                        <div class="plaid-features">
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>256-bit SSL encryption</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Bank-level security</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>No account numbers stored</span>
                            </div>
                            <div class="feature-item">
                                <i class="fas fa-check-circle"></i>
                                <span>Read-only access</span>
                            </div>
                        </div>
                        
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="set-default-bank-plaid">
                            <label for="set-default-bank-plaid">Set as default payment method</label>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn btn-outline" onclick="closeModal('add-payment-modal')">Cancel</button>
                            <button type="button" class="btn btn-primary" id="plaid-link-button" onclick="initiatePlaidBankLink()">
                                <i class="fas fa-university"></i>
                                Connect Bank Account
                            </button>
                        </div>
                        
                        <div id="plaid-link-status" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 8px;">
                            <p id="plaid-status-message"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load user information from localStorage
        document.addEventListener('DOMContentLoaded', function() {
            const userName = localStorage.getItem('snackreach_user_name');
            const companyName = localStorage.getItem('snackreach_company_name');
            
            if (userName && companyName) {
                document.getElementById('user-name').textContent = companyName;
            }
            
            // Check if user is logged in - but don't redirect if already on dashboard
            // Session persists - user stays logged in until explicit logout
            const token = localStorage.getItem('snackreach_token');
            const userType = localStorage.getItem('snackreach_user_type');
            if (!token || !userType || userType !== 'startup') {
                // Only redirect if truly not logged in
                alert('Please log in to access the snack company dashboard.');
                window.location.href = 'login.html';
                return;
            }
            
            loadSnackProfile();
            loadPaymentMethods();
            loadOffices();
            loadMessages();
        });
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        
        function showAddPaymentModal() {
            document.getElementById('add-payment-modal').style.display = 'block';
            // Reset forms
            document.getElementById('card-payment-form').reset();
            document.getElementById('bank-payment-form').reset();
            switchPaymentType('card');
        }
        
        function switchPaymentType(type) {
            const cardForm = document.getElementById('card-payment-form');
            const bankForm = document.getElementById('bank-payment-form');
            const cardTab = document.querySelectorAll('.payment-tab-btn')[0];
            const bankTab = document.querySelectorAll('.payment-tab-btn')[1];
            
            if (type === 'card') {
                cardForm.style.display = 'block';
                bankForm.style.display = 'none';
                cardTab.classList.add('active');
                bankTab.classList.remove('active');
            } else {
                cardForm.style.display = 'none';
                bankForm.style.display = 'block';
                cardTab.classList.remove('active');
                bankTab.classList.add('active');
            }
        }
        
        // Initialize Plaid Link for bank accounts
        async function initiatePlaidBankLink() {
            const button = document.getElementById('plaid-link-button');
            const statusDiv = document.getElementById('plaid-link-status');
            const statusMessage = document.getElementById('plaid-status-message');
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
            statusDiv.style.display = 'block';
            statusMessage.textContent = 'Initializing secure bank connection...';
            
            try {
                await window.PlaidLink.setup(
                    // onSuccess callback
                    (data) => {
                        statusDiv.style.background = '#d4edda';
                        statusMessage.innerHTML = `<i class="fas fa-check-circle"></i> Bank account linked successfully!<br>Account ending in ${data.last4}`;
                        button.style.display = 'none';
                        
                        // Reload payment methods
                        setTimeout(() => {
                            loadPaymentMethods();
                            closeModal('add-payment-modal');
                        }, 2000);
                    },
                    // onExit callback
                    (err, metadata) => {
                        if (err) {
                            statusDiv.style.background = '#f8d7da';
                            statusMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${err.display_message || 'Connection cancelled'}`;
                        } else {
                            statusDiv.style.display = 'none';
                        }
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-university"></i> Connect Bank Account';
                    }
                );
            } catch (error) {
                console.error('Plaid setup error:', error);
                statusDiv.style.background = '#f8d7da';
                statusMessage.innerHTML = `<i class="fas fa-exclamation-circle"></i> Error: ${error.message}`;
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-university"></i> Connect Bank Account';
            }
        }
        
        function loadPaymentMethods() {
            const paymentMethodsList = document.getElementById('payment-methods-list');
            const noPaymentMethods = document.getElementById('no-payment-methods');
            
            // Get payment methods from localStorage
            const userData = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            const companyName = localStorage.getItem('snackreach_company_name');
            const currentUser = userData.find(u => u.companyName === companyName);
            
            const paymentMethods = currentUser?.paymentMethods || [];
            
            // Also check signup card info
            if (currentUser?.cardInfo && !paymentMethods.find(pm => pm.type === 'card' && pm.source === 'signup')) {
                paymentMethods.push({
                    id: 'signup-card',
                    type: 'card',
                    cardType: 'Visa', // Default, could be detected from number
                    last4: currentUser.cardInfo.number.slice(-4),
                    expiry: currentUser.cardInfo.expiry,
                    name: currentUser.cardInfo.name,
                    isDefault: !paymentMethods.length,
                    source: 'signup'
                });
            }
            
            if (paymentMethods.length === 0) {
                paymentMethodsList.innerHTML = '';
                noPaymentMethods.style.display = 'block';
                return;
            }
            
            noPaymentMethods.style.display = 'none';
            paymentMethodsList.innerHTML = '';
            
            paymentMethods.forEach((method, index) => {
                const methodCard = document.createElement('div');
                methodCard.className = `payment-method-card ${method.isDefault ? 'default' : ''}`;
                
                if (method.type === 'card') {
                    const cardIcon = getCardIcon(method.cardType);
                    methodCard.innerHTML = `
                        <div class="payment-method-info">
                            <div class="payment-method-icon">${cardIcon}</div>
                            <div class="payment-method-details">
                                <h5>${method.cardType} •••• ${method.last4}</h5>
                                <p>Expires ${method.expiry}</p>
                                <p class="method-name">${method.name}</p>
                            </div>
                        </div>
                        <div class="payment-method-actions">
                            ${method.isDefault ? '<span class="default-badge">Default</span>' : ''}
                            <button class="btn-icon" onclick="setDefaultPaymentMethod('${method.id}')" title="Set as default">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="btn-icon" onclick="removePaymentMethod('${method.id}')" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                } else if (method.type === 'bank') {
                    methodCard.innerHTML = `
                        <div class="payment-method-info">
                            <div class="payment-method-icon"><i class="fas fa-university"></i></div>
                            <div class="payment-method-details">
                                <h5>${method.bankName} ${method.accountType}</h5>
                                <p>••••${method.accountLast4}</p>
                                <p class="method-name">${method.accountHolderName}</p>
                            </div>
                        </div>
                        <div class="payment-method-actions">
                            ${method.isDefault ? '<span class="default-badge">Default</span>' : ''}
                            <button class="btn-icon" onclick="setDefaultPaymentMethod('${method.id}')" title="Set as default">
                                <i class="fas fa-star"></i>
                            </button>
                            <button class="btn-icon" onclick="removePaymentMethod('${method.id}')" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
                
                paymentMethodsList.appendChild(methodCard);
            });
        }
        
        function getCardIcon(cardType) {
            const icons = {
                'visa': '<i class="fab fa-cc-visa"></i>',
                'mastercard': '<i class="fab fa-cc-mastercard"></i>',
                'amex': '<i class="fab fa-cc-amex"></i>',
                'discover': '<i class="fab fa-cc-discover"></i>',
                'Visa': '<i class="fab fa-cc-visa"></i>',
                'Mastercard': '<i class="fab fa-cc-mastercard"></i>',
                'American Express': '<i class="fab fa-cc-amex"></i>',
                'Discover': '<i class="fab fa-cc-discover"></i>'
            };
            return icons[cardType] || '<i class="fas fa-credit-card"></i>';
        }
        
        // Handle card form submission
        document.getElementById('card-payment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const cardType = document.getElementById('card-type').value;
            const cardNumber = document.getElementById('card-number-new').value.replace(/\s/g, '');
            const expiry = document.getElementById('card-expiry-new').value;
            const cvv = document.getElementById('card-cvv-new').value;
            const name = document.getElementById('card-name-new').value;
            const address = document.getElementById('card-billing-address').value;
            const isDefault = document.getElementById('set-default-card').checked;
            
            // Validate card number
            if (cardNumber.length < 13 || cardNumber.length > 19) {
                alert('Please enter a valid card number');
                return;
            }
            
            const last4 = cardNumber.slice(-4);
            
            // Save payment method
            const paymentMethod = {
                id: 'card-' + Date.now(),
                type: 'card',
                cardType: cardType.charAt(0).toUpperCase() + cardType.slice(1),
                last4: last4,
                expiry: expiry,
                name: name,
                billingAddress: address,
                isDefault: isDefault,
                addedAt: new Date().toISOString()
            };
            
            savePaymentMethod(paymentMethod);
            closeModal('add-payment-modal');
            loadPaymentMethods();
            alert('Card added successfully!');
        });
        
        // Handle bank form submission
        document.getElementById('bank-payment-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            let bankName = document.getElementById('bank-name').value;
            if (bankName === 'other') {
                bankName = document.getElementById('other-bank-name').value;
            }
            
            const accountType = document.getElementById('account-type').value;
            const accountNumber = document.getElementById('account-number').value;
            const routingNumber = document.getElementById('routing-number').value;
            const accountHolderName = document.getElementById('account-holder-name').value;
            const isDefault = document.getElementById('set-default-bank').checked;
            
            // Validate routing number
            if (routingNumber.length !== 9) {
                alert('Routing number must be 9 digits');
                return;
            }
            
            const accountLast4 = accountNumber.slice(-4);
            
            // Save payment method
            const paymentMethod = {
                id: 'bank-' + Date.now(),
                type: 'bank',
                bankName: bankName,
                accountType: accountType,
                accountLast4: accountLast4,
                routingNumber: routingNumber.slice(0, 4) + '*****', // Partially mask
                accountHolderName: accountHolderName,
                isDefault: isDefault,
                addedAt: new Date().toISOString()
            };
            
            savePaymentMethod(paymentMethod);
            closeModal('add-payment-modal');
            loadPaymentMethods();
            alert('Bank account linked successfully!');
        });
        
        function savePaymentMethod(paymentMethod) {
            const userData = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            const companyName = localStorage.getItem('snackreach_company_name');
            const userIndex = userData.findIndex(u => u.companyName === companyName);
            
            if (userIndex !== -1) {
                if (!userData[userIndex].paymentMethods) {
                    userData[userIndex].paymentMethods = [];
                }
                
                // If this is default, unset other defaults
                if (paymentMethod.isDefault) {
                    userData[userIndex].paymentMethods.forEach(pm => {
                        pm.isDefault = false;
                    });
                }
                
                userData[userIndex].paymentMethods.push(paymentMethod);
                localStorage.setItem('snackreach_users', JSON.stringify(userData));
                
                // Try to save to backend
                const token = localStorage.getItem('snackreach_token');
                if (token) {
                    fetch(`http://localhost:3000/api/payment-methods`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(paymentMethod)
                    }).catch(error => {
                        console.log('Backend not available, saved locally');
                    });
                }
            }
        }
        
        function setDefaultPaymentMethod(methodId) {
            const userData = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            const companyName = localStorage.getItem('snackreach_company_name');
            const userIndex = userData.findIndex(u => u.companyName === companyName);
            
            if (userIndex !== -1 && userData[userIndex].paymentMethods) {
                userData[userIndex].paymentMethods.forEach(pm => {
                    pm.isDefault = pm.id === methodId;
                });
                localStorage.setItem('snackreach_users', JSON.stringify(userData));
                loadPaymentMethods();
            }
        }
        
        function removePaymentMethod(methodId) {
            if (!confirm('Are you sure you want to remove this payment method?')) {
                return;
            }
            
            const userData = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            const companyName = localStorage.getItem('snackreach_company_name');
            const userIndex = userData.findIndex(u => u.companyName === companyName);
            
            if (userIndex !== -1 && userData[userIndex].paymentMethods) {
                userData[userIndex].paymentMethods = userData[userIndex].paymentMethods.filter(pm => pm.id !== methodId);
                localStorage.setItem('snackreach_users', JSON.stringify(userData));
                loadPaymentMethods();
            }
        }
        
        function loadSnackProfile() {
            const API_BASE_URL = 'http://localhost:3000/api';
            
            // Try to load from backend
            const token = localStorage.getItem('snackreach_token');
            if (token) {
                fetch(`${API_BASE_URL}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.name) {
                        document.getElementById('profile-name').value = data.name || '';
                        document.getElementById('profile-email').value = data.email || '';
                        document.getElementById('profile-phone').value = data.phone || '';
                        document.getElementById('profile-company').value = data.companyName || '';
                    }
                })
                .catch(error => {
                    console.log('Backend not available, loading from localStorage');
                    loadFromLocalStorage();
                });
            } else {
                loadFromLocalStorage();
            }
        }
        
        function loadFromLocalStorage() {
            const userName = localStorage.getItem('snackreach_user_name');
            const companyName = localStorage.getItem('snackreach_company_name');
            
            // Get user data from localStorage
            const users = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            const currentUser = users.find(u => u.companyName === companyName) || {};
            
            document.getElementById('profile-name').value = userName || currentUser.name || '';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-phone').value = currentUser.phone || '';
            document.getElementById('profile-company').value = companyName || currentUser.companyName || '';
            document.getElementById('profile-bio').value = currentUser.bio || '';
        }
        
        // Save snack profile
        document.getElementById('snack-profile-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('profile-name').value;
            const email = document.getElementById('profile-email').value;
            const phone = document.getElementById('profile-phone').value;
            const company = document.getElementById('profile-company').value;
            const bio = document.getElementById('profile-bio').value;
            
            // Update localStorage
            localStorage.setItem('snackreach_user_name', name);
            localStorage.setItem('snackreach_company_name', company);
            document.getElementById('user-name').textContent = company;
            
            // Update user data in localStorage
            const users = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            const currentCompany = localStorage.getItem('snackreach_company_name');
            const userIndex = users.findIndex(u => u.companyName === currentCompany || u.email === email);
            
            if (userIndex !== -1) {
                users[userIndex].name = name;
                users[userIndex].email = email;
                users[userIndex].phone = phone;
                users[userIndex].companyName = company;
                users[userIndex].bio = bio;
                localStorage.setItem('snackreach_users', JSON.stringify(users));
            } else {
                // Create new user entry
                const newUser = {
                    id: Date.now().toString(),
                    name,
                    email,
                    phone,
                    companyName: company,
                    bio,
                    userType: 'startup',
                    createdAt: new Date().toISOString()
                };
                users.push(newUser);
                localStorage.setItem('snackreach_users', JSON.stringify(users));
            }
            
            // Try to save to backend
            const token = localStorage.getItem('snackreach_token');
            if (token) {
                try {
                    await fetch(`http://localhost:3000/api/profile`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ name, email, phone, companyName: company })
                    });
                } catch (error) {
                    console.log('Backend not available, saved locally');
                }
            }
            
            alert('Profile updated successfully!');
        });
        
        // Change password
        document.getElementById('snack-password-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('snack-new-password').value;
            const confirmPassword = document.getElementById('snack-confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            // Update password in localStorage
            const users = JSON.parse(localStorage.getItem('snackreach_users') || '[]');
            const companyName = localStorage.getItem('snackreach_company_name');
            const userIndex = users.findIndex(u => u.companyName === companyName);
            
            if (userIndex !== -1) {
                users[userIndex].password = newPassword; // In real app, this would be hashed
                localStorage.setItem('snackreach_users', JSON.stringify(users));
            }
            
            document.getElementById('snack-password-form').reset();
            alert('Password changed successfully!');
        });
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Reload data when switching tabs
            if (tabName === 'discover') {
                loadOffices();
            } else if (tabName === 'messages') {
                loadMessages();
            }
        }
        
        // Logout function - only clears session on explicit logout
        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('snackreach_token');
                localStorage.removeItem('snackreach_user_type');
                localStorage.removeItem('snackreach_user_name');
                localStorage.removeItem('snackreach_company_name');
                window.location.href = 'index.html';
            }
        }
        
        // Delete account function
        async function deleteAccount() {
            const confirmMessage = 'Are you sure you want to permanently delete your account? This action cannot be undone.\n\n' +
                                  'All your data, messages, and account information will be permanently deleted.';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation
            const doubleConfirm = confirm('This is your last chance. Are you absolutely sure you want to delete your account?');
            if (!doubleConfirm) {
                return;
            }
            
            const API_BASE_URL = (() => {
                const hostname = window.location.hostname;
                if (hostname.includes('railway.app')) {
                    return '/api';
                } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    return 'https://snackreach-production.up.railway.app/api';
                } else {
                    return 'http://localhost:3000/api';
                }
            })();
            
            const token = localStorage.getItem('snackreach_token');
            
            try {
                const response = await fetch(`${API_BASE_URL}/account`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Your account has been permanently deleted.');
                    // Clear all local storage
                    localStorage.clear();
                    // Redirect to home page
                    window.location.href = 'index.html';
                } else {
                    alert('Error deleting account: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                alert('Failed to delete account. Please try again.');
            }
        }
        
        // Show cancel subscription modal
        function showCancelModal() {
            document.getElementById('cancel-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // Confirm subscription cancellation
        function confirmCancellation() {
            const reason = document.getElementById('cancel-reason').value;
            if (!reason) {
                alert('Please select a reason for canceling.');
                return;
            }
            
            alert('Your subscription has been canceled. You can reactivate it anytime from your profile.');
            closeModal('cancel-modal');
        }
        
        // Profile form submission
        document.addEventListener('DOMContentLoaded', function() {
            const profileForm = document.querySelector('.profile-form');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    alert('Profile updated successfully!');
                });
            }
            
            // Handle new message form submission
            const newMessageForm = document.getElementById('new-message-form');
            if (newMessageForm) {
                newMessageForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const toUserId = document.getElementById('message-to').value;
                    const subject = document.getElementById('message-subject').value;
                    const message = document.getElementById('message-body').value;
                    const errorDiv = document.getElementById('message-error');
                    
                    errorDiv.style.display = 'none';
                    
                    const API_BASE_URL = (() => {
                        const hostname = window.location.hostname;
                        if (hostname.includes('railway.app')) {
                            return '/api';
                        } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                            return 'https://snackreach-production.up.railway.app/api';
                        } else {
                            return 'http://localhost:3000/api';
                        }
                    })();
                    
                    const token = localStorage.getItem('snackreach_token');
                    const submitBtn = this.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/messages`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ toUserId, subject, message })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            closeModal('new-message-modal');
                            loadMessages();
                            alert('Message sent successfully!');
                        } else {
                            errorDiv.textContent = data.error || 'Failed to send message';
                            errorDiv.style.display = 'block';
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = originalText;
                        }
                    } catch (error) {
                        console.error('Error sending message:', error);
                        errorDiv.textContent = 'Failed to send message. Please try again.';
                        errorDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                });
            }
        });
        
        // Load offices for startups to message
        async function loadOffices() {
            const container = document.getElementById('offices-list-container');
            if (!container) return;
            
            const API_BASE_URL = (() => {
                const hostname = window.location.hostname;
                if (hostname.includes('railway.app')) {
                    return '/api';
                } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    return 'https://snackreach-production.up.railway.app/api';
                } else {
                    return 'http://localhost:3000/api';
                }
            })();
            
            const token = localStorage.getItem('snackreach_token');
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/offices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load offices');
                
                const offices = await response.json();
                
                if (offices.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-building"></i></div>
                            <h4>No offices found yet</h4>
                            <p>Office spaces will appear here once they join SnackReach.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div class="offices-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                        ${offices.map(office => `
                            <div class="office-card" style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <h4 style="margin: 0 0 0.5rem 0; color: #1f2937;">${escapeHtml(office.companyName || office.name)}</h4>
                                <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.9rem;">${escapeHtml(office.name || 'Office Manager')}</p>
                                <button class="btn btn-primary btn-small" onclick="showNewMessageModal('${office.id}', '${escapeHtml(office.companyName || office.name).replace(/'/g, "\\'")}')" style="width: 100%;">
                                    <i class="fas fa-envelope"></i> Message
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading offices:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
                        <h4>Error loading offices</h4>
                        <p>Please try again later.</p>
                    </div>
                `;
            }
        }
        
        // Load messages for current user
        async function loadMessages() {
            const container = document.getElementById('messages-container');
            if (!container) return;
            
            const API_BASE_URL = (() => {
                const hostname = window.location.hostname;
                if (hostname.includes('railway.app')) {
                    return '/api';
                } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    return 'https://snackreach-production.up.railway.app/api';
                } else {
                    return 'http://localhost:3000/api';
                }
            })();
            
            const token = localStorage.getItem('snackreach_token');
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) throw new Error('Failed to load messages');
                
                const messages = await response.json();
                
                if (messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-comments"></i></div>
                            <h4>No messages yet</h4>
                            <p>Start a conversation with an office or view messages from office managers.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = messages.map(msg => {
                    const isSent = msg.fromUserType === 'startup';
                    const otherParty = isSent ? msg.toUserName : msg.fromUserName;
                    
                    return `
                        <div class="message-item" style="background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid ${isSent ? '#667eea' : '#10b981'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <strong style="color: #1f2937;">${isSent ? 'To' : 'From'}: ${escapeHtml(otherParty)}</strong>
                                    <span style="color: #6b7280; font-size: 0.85rem; margin-left: 1rem;">${new Date(msg.timestamp).toLocaleString()}</span>
                                </div>
                                ${!isSent && !msg.read ? '<span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">New</span>' : ''}
                            </div>
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: #1f2937; font-size: 1.1rem;">${escapeHtml(msg.subject)}</div>
                            <div style="color: #4b5563; line-height: 1.6; white-space: pre-wrap;">${escapeHtml(msg.message)}</div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon"><i class="fas fa-exclamation-circle"></i></div>
                        <h4>Error loading messages</h4>
                        <p>Please try again later.</p>
                    </div>
                `;
            }
        }
        
        // Show new message modal
        async function showNewMessageModal(officeId = null, officeName = null) {
            const modal = document.getElementById('new-message-modal');
            const toSelect = document.getElementById('message-to');
            const form = document.getElementById('new-message-form');
            
            if (!modal || !toSelect || !form) return;
            
            const API_BASE_URL = (() => {
                const hostname = window.location.hostname;
                if (hostname.includes('railway.app')) {
                    return '/api';
                } else if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                    return 'https://snackreach-production.up.railway.app/api';
                } else {
                    return 'http://localhost:3000/api';
                }
            })();
            
            const token = localStorage.getItem('snackreach_token');
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/offices`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const offices = await response.json();
                    toSelect.innerHTML = '<option value="">Select an office...</option>' +
                        offices.map(o => `<option value="${o.id}" ${officeId === o.id ? 'selected' : ''}>${escapeHtml(o.companyName || o.name)}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading offices:', error);
            }
            
            if (officeId) {
                toSelect.value = officeId;
            }
            
            form.reset();
            const errorDiv = document.getElementById('message-error');
            if (errorDiv) errorDiv.style.display = 'none';
            modal.style.display = 'flex';
        }
        
        // Utility function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
